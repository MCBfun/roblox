-- ç­‰å¾…æ ¸å¿ƒæœåŠ¡åŠ è½½
local success, errorMsg = pcall(function()
    -- è·å–æœåŠ¡
    local Players = game:GetService("Players")
    local RunService = game:GetService("RunService")
    local UserInputService = game:GetService("UserInputService")
    local SoundService = game:GetService("SoundService")
    local Debris = game:GetService("Debris")
    local TweenService = game:GetService("TweenService")

    -- å®‰å…¨è·å–æœ¬åœ°ç©å®¶
    local LocalPlayer = Players.LocalPlayer
    if not LocalPlayer then
        repeat wait(0.1) until Players.LocalPlayer
        LocalPlayer = Players.LocalPlayer
    end

    -- å®‰å…¨è·å–PlayerGui
    local PlayerGui = LocalPlayer:WaitForChild("PlayerGui", 10)
    if not PlayerGui then
        warn("æ— æ³•åŠ è½½ï¼šPlayerGuiè·å–è¶…æ—¶")
        return
    end

    -- 1. åˆ›å»ºåŸºç¡€GUIå®¹å™¨
æœ¬åœ°ScreenGui=Instance.new("ScreenGui")
ScreenGui.Name="å¤šåŠŸèƒ½GUI_V2"
ScreenGui.ResetOnSpawn=false
ScreenGui.ZIndexBehavior=æšä¸¾.ZIndexBehavior.Sibling
ScreenGui.Parent=PlayerGui

-- 2. åˆ›å»ºä¸»çª—å£
æœ¬åœ°MainFrame=Instance.new("Frame")
MainFrame.Size=UDim2.new(0ï¼Œ240ï¼Œ0ï¼Œ120)
MainFrame.Position=UDim2.new(1ï¼Œ-595ï¼Œ0ï¼Œ7)
MainFrame.AnchorPoint=Vector2.new(1ï¼Œ0)
MainFrame.BackgroundColor3=Color3.fromRGB(40ï¼Œ40ï¼Œ40)
MainFrame.BorderSizePixel=0
MainFrame.Parent=ScreenGui

-- åœ†è§’
æœ¬åœ°MainCorner=Instance.new("UICorner")
MainCorner.CornerRadius=UDim.new(0ï¼Œ1)
MainCorner.Parent=MainFrame

-- 3. æ ‡é¢˜æ 
æœ¬åœ°æ ‡é¢˜æ =Instance.new("Frame")
TitleBar.Size=UDim2.new(1ï¼Œ0ï¼Œ0ï¼Œ30)
TitleBar.BackgroundColor3=Color3.fromRGB(30ï¼Œ30ï¼Œ30)
TitleBar.BorderSizePixel=0
TitleBar.Parent=MainFrame

-- æ ‡é¢˜æ–‡å­—
æœ¬åœ°æ ‡é¢˜æ–‡æœ¬=Instance.new("TextLabel")
    TitleText.Size = UDim2.new(0, 120, 1, 0)
    TitleText.Position = UDim2.new(0, 10, 0, 0)
    TitleText.BackgroundTransparency = 1
    TitleText.Text = "åŠŸèƒ½é¢æ¿ V2"
    TitleText.TextColor3 = Color3.fromRGB(255, 255, 255)
    TitleText.TextSize = 14
    TitleText.Font = Enum.Font.SourceSansBold
    TitleText.TextXAlignment = Enum.TextXAlignment.Left
    TitleText.Parent = TitleBar

    -- æ§åˆ¶æŒ‰é’®
    local CloseBtn = Instance.new("TextButton")
    CloseBtn.Size = UDim2.new(0, 25, 0, 25)
    CloseBtn.Position = UDim2.new(1, -30, 0.5, -12)
    CloseBtn.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
    CloseBtn.Text = "Ã—"
    CloseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    CloseBtn.TextSize = 16
    CloseBtn.Parent = TitleBar

    local MinimizeBtn = Instance.new("TextButton")
    MinimizeBtn.Size = UDim2.new(0, 25, 0, 25)
    MinimizeBtn.Position = UDim2.new(1, -60, 0.5, -12)
    MinimizeBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
    MinimizeBtn.Text = "-"
    MinimizeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    MinimizeBtn.TextSize = 14
    MinimizeBtn.Parent = TitleBar

    -- 4. æŒ‰é’®å®¹å™¨
    local ButtonContainer = Instance.new("Frame")
    ButtonContainer.Size = UDim2.new(1, -20, 1, -40)
    ButtonContainer.Position = UDim2.new(0, 10, 0, 35)
    ButtonContainer.BackgroundTransparency = 1
    ButtonContainer.Parent = MainFrame

    local ListLayout = Instance.new("UIListLayout")
    ListLayout.Padding = UDim.new(0, 10)
    ListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    ListLayout.VerticalAlignment = Enum.VerticalAlignment.Center
    ListLayout.Parent = ButtonContainer

    -- åŠŸèƒ½æŒ‰é’®
    local buttons = {
        {name = "FarmBtn", text = "å¯åŠ¨åˆ·å–XP", color = Color3.fromRGB(200, 60, 60)},
        {name = "JumpBtn", text = "å¼€å¯é£è¡Œ", color = Color3.fromRGB(200, 60, 60)},
        {name = "NoclipBtn", text = "å¼€å¯ç©¿å¢™", color = Color3.fromRGB(200, 60, 60)},
        {name = "EspBtn", text = "å¼€å¯é€è§†", color = Color3.fromRGB(200, 60, 60)}
    }

    local function createButton(info)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(0, 160, 0, 35)
        btn.BackgroundColor3 = info.color
        btn.Text = info.text
        btn.TextColor3 = Color3.fromRGB(255, 255, 255)
        btn.TextSize = 14
        btn.Font = Enum.Font.SourceSansBold
        btn.Name = info.name
        btn.Parent = ButtonContainer
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 6)
        corner.Parent = btn
        
        return btn
    end

    local FarmBtn = createButton(buttons[1])
    local JumpBtn = createButton(buttons[2])
    local NoclipBtn = createButton(buttons[3])
    local EspBtn = createButton(buttons[4])

    -- 5. è¿·ä½ æŒ‰é’®
    local MiniBtn = Instance.new("TextButton")
    MiniBtn.Size = UDim2.new(0, 40, 0, 40)
    MiniBtn.Position = UDim2.new(0, 10, 0, 10)
    MiniBtn.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    MiniBtn.Text = "ğŸ˜"
    MiniBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    MiniBtn.TextSize = 12
    MiniBtn.Visible = false
    MiniBtn.ZIndex = 10
    MiniBtn.Parent = ScreenGui
    
    local MiniCorner = Instance.new("UICorner")
    MiniCorner.CornerRadius = UDim.new(0, 8)
    MiniCorner.Parent = MiniBtn

    -- 6. çŠ¶æ€å˜é‡
    local isFarmOn = false
    local isJumpOn = false
    local isNoclipOn = false
    local isEspOn = false
    local isMinimized = false
    local connections = {}
    local espObjects = {} -- å­˜å‚¨é€è§†å¯¹è±¡

    -- 7. å·¥å…·å‡½æ•°
    local function playClickSound()
        pcall(function()
            local sound = Instance.new("Sound")
            sound.SoundId = "rbxassetid://130785461"
            sound.Volume = 0.2
            sound.Parent = SoundService
            sound:Play()
            Debris:AddItem(sound, 2)
        end)
    end

    local function animateButton(btn)
        if not btn then return end
        local originalSize = btn.Size
        local tween = TweenService:Create(btn, TweenInfo.new(0.1), {Size = originalSize - UDim2.new(0, 4, 0, 4)})
        tween:Play()
        wait(0.1)
        if btn then
            TweenService:Create(btn, TweenInfo.new(0.1), {Size = originalSize}):Play()
        end
    end

    local function disconnectAll()
        for _, conn in ipairs(connections) do
            if conn and conn.Connected then
                conn:Disconnect()
            end
        end
        connections = {}
    end

    -- 8. é€è§†åŠŸèƒ½å®ç°
    local function getPlayerColor(player)
        -- å°è¯•è·å–é˜Ÿä¼é¢œè‰²
        if player.Team then
            return player.Team.TeamColor.Color
        end
        
        -- å°è¯•è·å–é˜Ÿä¼é¢œè‰²å±æ€§
        local teamColor = player:GetAttribute("TeamColor")
        if teamColor then
            return teamColor
        end
        
        -- é»˜è®¤é¢œè‰²ï¼ˆæ ¹æ®ç©å®¶IDç”Ÿæˆå”¯ä¸€é¢œè‰²ï¼‰
        local hue = (player.UserId % 360) / 360
        return Color3.fromHSV(hue, 0.8, 0.9)
    end

    local function removeCharacterEsp(player)
        if espObjects[player] then
            -- ç§»é™¤é«˜å…‰
            for _, highlight in ipairs(espObjects[player].highlights or {}) do
                if highlight and highlight.Parent then
                    highlight:Destroy()
                end
            end
            
            -- ç§»é™¤å…¬å‘Šæ¿
            for _, billboard in ipairs(espObjects[player].billboards or {}) do
                if billboard and billboard.Parent then
                    billboard:Destroy()
                end
            end
            
            espObjects[player].highlights = {}
            espObjects[player].billboards = {}
        end
    end

    local function removePlayerEsp(player)
        removeCharacterEsp(player)
        espObjects[player] = nil
    end

    local function removeEsp()
        for player, _ in pairs(espObjects) do
            removePlayerEsp(player)
        end
        espObjects = {}
    end

    local function createCharacterEsp(player, character)
        removeCharacterEsp(player) -- å…ˆç§»é™¤æ—§çš„
        
        -- ç­‰å¾…è§’è‰²åŠ è½½å®Œæˆ
        local humanoidRootPart = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso") or character:FindFirstChildWhichIsA("BasePart")
        local head = character:FindFirstChild("Head")
        
        if not humanoidRootPart then return end
        
        -- ä½¿ç”¨é«˜å…‰æ•ˆæœ
        local highlight = Instance.new("Highlight")
        highlight.Name = "ESP_Highlight"
        highlight.Adornee = character
        highlight.FillColor = getPlayerColor(player)
        highlight.FillTransparency = 0.7
        highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
        highlight.OutlineTransparency = 0.3
        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        highlight.Parent = game:GetService("CoreGui")
        
        -- åˆ›å»ºåå­—æ ‡ç­¾
        local billboard
        if head then
            billboard = Instance.new("BillboardGui")
            billboard.Name = "ESP_Billboard"
            billboard.Adornee = head
            billboard.Size = UDim2.new(0, 200, 0, 50)
            billboard.StudsOffset = Vector3.new(0, 3, 0)
            billboard.AlwaysOnTop = true
            billboard.MaxDistance = 150
            billboard.Parent = game:GetService("CoreGui")
            
            local nameLabel = Instance.new("TextLabel")
            nameLabel.Size = UDim2.new(1, 0, 0.6, 0)
            nameLabel.BackgroundTransparency = 1
            nameLabel.Text = player.Name
            nameLabel.TextColor3 = getPlayerColor(player)
            nameLabel.TextSize = 14
            nameLabel.Font = Enum.Font.SourceSansBold
            nameLabel.Parent = billboard
            
            local distanceLabel = Instance.new("TextLabel")
            distanceLabel.Size = UDim2.new(1, 0, 0.4, 0)
            distanceLabel.Position = UDim2.new(0, 0, 0.6, 0)
            distanceLabel.BackgroundTransparency = 1
            distanceLabel.Text = "è®¡ç®—ä¸­..."
            distanceLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
            distanceLabel.TextSize = 12
            distanceLabel.Font = Enum.Font.SourceSans
            distanceLabel.Parent = billboard
            
            -- æ›´æ–°è·ç¦»ä¿¡æ¯
            local distanceConn = RunService.Heartbeat:Connect(function()
                if not character or not character.Parent or not LocalPlayer.Character then
                    return
                end
                
                local localChar = LocalPlayer.Character
                local localRoot = localChar:FindFirstChild("HumanoidRootPart") or localChar:FindFirstChild("Torso") or localChar:FindFirstChildWhichIsA("BasePart")
                local targetRoot = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso") or character:FindFirstChildWhichIsA("BasePart")
                
                if localRoot and targetRoot then
                    local distance = (localRoot.Position - targetRoot.Position).Magnitude
                    distanceLabel.Text = string.format("%.1fm", distance)
                    
                    -- æ ¹æ®è·ç¦»è°ƒæ•´é€æ˜åº¦
                    local alpha = math.clamp(1 - (distance / 200), 0.2, 0.8)
                    highlight.FillTransparency = 1 - alpha
                    highlight.OutlineTransparency = 1 - alpha
                    
                    -- æ ¹æ®è·ç¦»è°ƒæ•´é¢œè‰²
                    if distance < 20 then
                        highlight.FillColor = Color3.fromRGB(255, 50, 50)
                    elseif distance < 50 then
                        highlight.FillColor = Color3.fromRGB(255, 150, 50)
                    else
                        highlight.FillColor = getPlayerColor(player)
                    end
                end
            end)
            table.insert(connections, distanceConn)
        end
        
        -- å­˜å‚¨é€è§†å¯¹è±¡
        espObjects[player] = espObjects[player] or {}
        espObjects[player].highlights = {highlight}
        if billboard then
            espObjects[player].billboards = {billboard}
        end
    end

    local function createPlayerEsp(player)
        if espObjects[player] then return end
        
        espObjects[player] = {
            highlights = {},
            billboards = {},
            player = player
        }
        
        -- ç›‘å¬è§’è‰²å˜åŒ–
        if player.Character then
            createCharacterEsp(player, player.Character)
        end
        
        local charAddedConn = player.CharacterAdded:Connect(function(character)
            createCharacterEsp(player, character)
        end)
        table.insert(connections, charAddedConn)
        
        local charRemovingConn = player.CharacterRemoving:Connect(function()
            removeCharacterEsp(player)
        end)
        table.insert(connections, charRemovingConn)
    end

    local function createEsp()
        removeEsp() -- å…ˆæ¸…é™¤ç°æœ‰çš„
        
        -- ä¸ºæ‰€æœ‰ç©å®¶åˆ›å»ºé€è§†
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                createPlayerEsp(player)
            end
        end
        
        -- ç›‘å¬æ–°ç©å®¶
        local playerAddedConn = Players.PlayerAdded:Connect(function(player)
            createPlayerEsp(player)
        end)
        table.insert(connections, playerAddedConn)
        
        -- ç›‘å¬ç©å®¶ç¦»å¼€
        local playerRemovingConn = Players.PlayerRemoving:Connect(function(player)
            removePlayerEsp(player)
        end)
        table.insert(connections, playerRemovingConn)
    end

    local function toggleEsp()
        isEspOn = not isEspOn
        
        if isEspOn then
            EspBtn.BackgroundColor3 = Color3.fromRGB(200, 100, 255)
            EspBtn.Text = "é€è§†å·²å¼€"
            createEsp()
        else
            EspBtn.BackgroundColor3 = Color3.fromRGB(150, 60, 200)
            EspBtn.Text = "å¼€å¯é€è§†"
            removeEsp()
        end
    end

    -- 9. å…¶ä»–åŠŸèƒ½å®ç°
    local function toggleFarm()
        isFarmOn = not isFarmOn
        FarmBtn.BackgroundColor3 = isFarmOn and Color3.fromRGB(60, 200, 60) or Color3.fromRGB(200, 60, 60)
        FarmBtn.Text = isFarmOn and "å†œåœºè¿è¡Œä¸­" or "å¯åŠ¨å†œåœº"
        
        if isFarmOn then
            local conn = RunService.Heartbeat:Connect(function()
                pcall(function()
                    -- ç®€åŒ–çš„å†œåœºé€»è¾‘
                end)
            end)
            table.insert(connections, conn)
        else
            disconnectAll()
        end
    end

    local function toggleJump()
        isJumpOn = not isJumpOn
        JumpBtn.BackgroundColor3 = isJumpOn and Color3.fromRGB(60, 200, 200) or Color3.fromRGB(60, 60, 200)
        JumpBtn.Text = isJumpOn and "æ— é™è·³å·²å¼€" or "å¼€å¯æ— é™è·³"
        
        if isJumpOn then
            local conn = UserInputService.JumpRequest:Connect(function()
                pcall(function()
                    local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
                    if humanoid then
                        humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
                    end
                end)
            end)
            table.insert(connections, conn)
        else
            disconnectAll()
        end
    end

    local function toggleNoclip()
        isNoclipOn = not isNoclipOn
        NoclipBtn.BackgroundColor3 = isNoclipOn and Color3.fromRGB(255, 200, 60) or Color3.fromRGB(200, 150, 60)
        NoclipBtn.Text = isNoclipOn and "ç©¿å¢™å·²å¼€" or "å¼€å¯ç©¿å¢™"
        
        if isNoclipOn then
            local conn = RunService.Stepped:Connect(function()
                pcall(function()
                    local character = LocalPlayer.Character
                    if character then
                        for _, part in ipairs(character:GetDescendants()) do
                            if part:IsA("BasePart") then
                                part.CanCollide = false
                            end
                        end
                    end
                end)
            end)
            table.insert(connections, conn)
        else
            disconnectAll()
            pcall(function()
                local character = LocalPlayer.Character
                if character then
                    for _, part in ipairs(character:GetDescendants()) do
                        if part:IsA("BasePart") then
                            part.CanCollide = true
                        end
                    end
                end
            end)
        end
    end

    -- 10. æŒ‰é’®äº‹ä»¶
    FarmBtn.MouseButton1Click:Connect(function()
        playClickSound()
        animateButton(FarmBtn)
        toggleFarm()
    end)

    JumpBtn.MouseButton1Click:Connect(function()
        playClickSound()
        animateButton(JumpBtn)
        toggleJump()
    end)

    NoclipBtn.MouseButton1Click:Connect(function()
        playClickSound()
        animateButton(NoclipBtn)
        toggleNoclip()
    end)

    EspBtn.MouseButton1Click:Connect(function()
        playClickSound()
        animateButton(EspBtn)
        toggleEsp()
    end)

    CloseBtn.MouseButton1Click:Connect(function()
        playClickSound()
        animateButton(CloseBtn)
        disconnectAll()
        removeEsp()
        ScreenGui:Destroy()
    end)

    MinimizeBtn.MouseButton1Click:Connect(function()
        playClickSound()
        animateButton(MinimizeBtn)
        isMinimized = not isMinimized
        MainFrame.Visible = not isMinimized
        MiniBtn.Visible = isMinimized
        if isMinimized then
            MiniBtn.Position = MainFrame.Position
            MiniBtn.Text = "åŠŸèƒ½"
        end
    end)

MiniBtn.MouseButton1å•å‡»ï¼šè¿æ¥(å‡½æ•°()
playClickSound()
åŠ¨ç”»æŒ‰é’®(MiniBtn)
isMinimized=false
MainFrame.Visible=true
MiniBtn.Visible=false
ç»“æŸ)

-- 11. æ‹–åŠ¨åŠŸèƒ½
æœ¬åœ°æ‹–åŠ¨=å‡çš„
æœ¬åœ°dragstartï¼Œstartpos

æœ¬åœ°å‡½æ•°startDrag(è¾“å…¥)
å¦‚æœinput.UserInputType==æšä¸¾ã€‚UserInputType.é¼ æ ‡æŒ‰é’®1ï¼Œåˆ™
æ‹–åŠ¨=çœŸ
dragstart=è¾“å…¥.ä½ç½®
startpos=MainFrame.Position
ç»“æŸ
ç»“æŸ

TitleBar.InputBeganï¼šè¿æ¥(startDrag)

UserInputService.InputChangedï¼šè¿æ¥(å‡½æ•°(è¾“å…¥)
å¦‚æœæ‹–åŠ¨å¹¶è¾“å…¥ã€‚UserInputType==æšä¸¾ã€‚UserInputTypeã€‚é¼ æ ‡ç§»åŠ¨ï¼Œåˆ™
æœ¬åœ°å¢é‡=è¾“å…¥ã€‚ ä½ç½®-æ‹–åŠ¨å¼€å§‹
MainFrame.Position=UDim2.new(
startPos.X.Scaleï¼ŒstartPos.X.Offset+delta.Xï¼Œ
startPos.Y.Scaleï¼ŒstartPos.Y.Offset+delta.Y
)
ç»“æŸ
ç»“æŸ)

UserInputService.InputEndedï¼šè¿æ¥(å‡½æ•°(è¾“å…¥)
å¦‚æœinput.UserInputType==æšä¸¾ã€‚UserInputType.é¼ æ ‡æŒ‰é’®1ï¼Œåˆ™
æ‹–åŠ¨=å‡çš„
ç»“æŸ
ç»“æŸ)

-- åŠ è½½å®Œæˆ
print("å¤šåŠŸèƒ½é¢æ¿V2åŠ è½½æˆåŠŸï¼åŒ…å«å®Œæ•´é€è§†åŠŸèƒ½")
ç»“æŸ)

å¦‚æœä¸æˆåŠŸé‚£ä¹ˆ
warn("è„šæœ¬åŠ è½½å¤±è´¥ï¼š"ï¼Œerrormsg)
ç»“æŸ
