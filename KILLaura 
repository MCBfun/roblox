local SoundService = game:GetService("SoundService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")

-- 音频初始化
local sound = Instance.new("Sound")
sound.SoundId = "rbxassetid://7390036132"
sound.Parent = SoundService
sound:Play()

local player = Players.LocalPlayer
local isRunning = true
local camera = Workspace.CurrentCamera
local comboNotifyFlag = false

-- ========== 弹窗提示函数（复用 Monster版） ==========
local function createNotification(text, color)
    local existingNotify = player.PlayerGui:FindFirstChild("KillauraNotify")
    if existingNotify then existingNotify:Destroy() end
    local notifyGui = Instance.new("ScreenGui")
    notifyGui.Name = "KillauraNotify"
    notifyGui.IgnoreGuiInset = true
    notifyGui.Parent = player.PlayerGui

    local notifyFrame = Instance.new("Frame")
    notifyFrame.Size = UDim2.new(0,220,0,60)
    notifyFrame.Position = UDim2.new(1,-230,1,-90)
    notifyFrame.BackgroundColor3 = Color3.fromRGB(25,25,30)
    notifyFrame.BackgroundTransparency = 0.1
    notifyFrame.Parent = notifyGui
    Instance.new("UICorner", notifyFrame).CornerRadius = UDim.new(0,8)
    Instance.new("UIStroke", notifyFrame).Color = color or Color3.fromRGB(60,60,70)
    
    local notifyLabel = Instance.new("TextLabel")
    notifyLabel.Size = UDim2.new(1,-10,1,-10)
    notifyLabel.Position = UDim2.new(0,5,0,5)
    notifyLabel.BackgroundTransparency = 1
    notifyLabel.Text = text
    notifyLabel.TextColor3 = Color3.fromRGB(240,240,240)
    notifyLabel.TextSize = 14
    notifyLabel.TextWrapped = true
    notifyLabel.Font = Enum.Font.SourceSansSemibold
    notifyLabel.Parent = notifyFrame

    -- 淡入动画
    notifyFrame.BackgroundTransparency = 1
    notifyFrame.Position = UDim2.new(1,-200,1,-90)
    TweenService:Create(notifyFrame, TweenInfo.new(0.3), {
        BackgroundTransparency = 0.1,
        Position = UDim2.new(1,-230,1,-90)
    }):Play()

    -- 3秒后淡出销毁
    task.wait(3)
    local fadeTween = TweenService:Create(notifyFrame, TweenInfo.new(0.3), {
        BackgroundTransparency = 1,
        Position = UDim2.new(1,-200,1,-90)
    })
    fadeTween:Play()
    fadeTween.Completed:Wait()
    notifyGui:Destroy()
end

-- ========== 创建 Monster样式UI（替换为鸭子logo 98446998103932） ==========
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "MonsterKillauraGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- 主面板（与 Monster尺寸/样式一致）
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 120, 0, 215)
mainFrame.Position = UDim2.new(0.02, 0, 0.3, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
mainFrame.BackgroundTransparency = 0.1
mainFrame.BorderSizePixel = 1
mainFrame.BorderColor3 = Color3.fromRGB(60, 60, 70)
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.ClipsDescendants = true
mainFrame.Parent = screenGui

-- 主面板圆角
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 6)

-- 标题栏（ Monster同款）
local titleBar = Instance.new("Frame")
titleBar.Name = "TitleBar"
titleBar.Size = UDim2.new(1, 0, 0, 25)
titleBar.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame
Instance.new("UICorner", titleBar).CornerRadius = UDim.new(0, 6)

-- 替换为鸭子logo（ID: 98446998103932）
local titleImage = Instance.new("ImageLabel")
titleImage.Name = "TitleDuckImage"
titleImage.Size = UDim2.new(0, 20, 0, 20)
titleImage.Position = UDim2.new(0, 5, 0, 2)
titleImage.BackgroundTransparency = 1
titleImage.Image = "rbxassetid://98446998103932"
titleImage.ScaleType = Enum.ScaleType.Fit
titleImage.Parent = titleBar

-- 标题文字（Monster）放在图片右侧
local titleText = Instance.new("TextLabel")
titleText.Text = " Monster"
titleText.Size = UDim2.new(1, -30, 1, 0)
titleText.Position = UDim2.new(0, 25, 0, 0)
titleText.BackgroundTransparency = 1
titleText.TextColor3 = Color3.fromRGB(220, 220, 220)
titleText.TextXAlignment = Enum.TextXAlignment.Left
titleText.Font = Enum.Font.SourceSansSemibold
titleText.TextSize = 14
titleText.Parent = titleBar

-- 控制按钮容器
local controlButtons = Instance.new("Frame")
controlButtons.Size = UDim2.new(0, 75, 1, 0)
controlButtons.Position = UDim2.new(1, -75, 0, 0)
controlButtons.BackgroundTransparency = 1
controlButtons.Parent = titleBar

-- 控制按钮创建函数（复用 Monster样式）
local function createCtrlBtn(parent, pos, text, color)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0,25,0,25)
    btn.Position = pos
    btn.Text = text
    btn.BackgroundColor3 = color
    btn.TextColor3 = Color3.fromRGB(220,220,220)
    btn.Font = Enum.Font.SourceSansBold
    btn.TextSize = 14
    btn.AutoButtonColor = false
    btn.Parent = parent
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0,4)
    -- 悬停效果
    local origColor = btn.BackgroundColor3
    btn.MouseEnter:Connect(function() btn.BackgroundColor3 = Color3.fromRGB(origColor.R*255+15, origColor.G*255+15, origColor.B*255+15)/255 end)
    btn.MouseLeave:Connect(function() btn.BackgroundColor3 = origColor end)
    return btn
end

-- 创建控制按钮（与 Monster一致）
local zoomBtn = createCtrlBtn(controlButtons, UDim2.new(0,0,0,0), "⏺️", Color3.fromRGB(40,40,45))
local minimizeBtn = createCtrlBtn(controlButtons, UDim2.new(0,25,0,0), "_", Color3.fromRGB(40,40,45))
local closeBtn = createCtrlBtn(controlButtons, UDim2.new(0,50,0,0), "×", Color3.fromRGB(45,35,35))

-- 功能按钮创建函数（ Monster同款样式）
local function createFuncBtn(parent, pos, text)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1,-10,0,40)
    btn.Position = pos
    btn.Text = text
    btn.BackgroundColor3 = Color3.fromRGB(35,35,40)
    btn.TextColor3 = Color3.fromRGB(220,220,220)
    btn.Font = Enum.Font.SourceSansSemibold
    btn.TextSize = 14
    btn.AutoButtonColor = false
    btn.Parent = parent
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0,5)
    -- 悬停效果
    local origColor = btn.BackgroundColor3
    btn.MouseEnter:Connect(function() btn.BackgroundColor3 = Color3.fromRGB(50,50,55) end)
    btn.MouseLeave:Connect(function() btn.BackgroundColor3 = origColor end)
    return btn
end

-- 创建原Killaura功能按钮（位置与 Monster一致）
local comboButton = createFuncBtn(mainFrame, UDim2.new(0,5,0,30), "杀戮光环 [关]")
local cycleTeleportButton = createFuncBtn(mainFrame, UDim2.new(0,5,0,75), "轮流传送")
local autoPipeButton = createFuncBtn(mainFrame, UDim2.new(0,5,0,120), "自动管道")

-- 缩小状态提示标签（替换剑emoji为鸭子logo文字提示）
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1,-10,1,-10)
statusLabel.Position = UDim2.new(0,5,0,5)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "Monster\n点击展开"
statusLabel.TextColor3 = Color3.fromRGB(180,180,180)
statusLabel.TextSize = 12
statusLabel.TextWrapped = true
statusLabel.Visible = false
statusLabel.Parent = mainFrame

-- ========== 状态变量（复用原逻辑+ Monster UI状态） ==========
local isComboActive = false
local isMinimized = false
local isZoomed = false
local originalSize = mainFrame.Size
local minimizedSize = UDim2.new(0,80,0,40)
local zoomedSize = UDim2.new(0,140,0,225)
local maxDistance = 200
local teleportHeight = 0
local lastAttackTime = 0
local attackRate = 4
local cycleTeleportIndex = 1

-- 管道坐标（保留原数据）
local allPipeLocations = {
    Vector3.new(43.06, 68.98, -254.75),
    Vector3.new(-0.53, 71.14, -329.87),
    Vector3.new(12.90, 94.29, -531.77),
    Vector3.new(-13.55, 87.70, -455.12),
    Vector3.new(-38.72, 87.45, -269.56),
    Vector3.new(-60.21, 105.48, -156.82),
    Vector3.new(-44.85, 112.19, -398.75),
    Vector3.new(73.64, 105.44, -404.03),
    Vector3.new(327.87, 37.94, 246.22),
    Vector3.new(386.97, 7.47, 331.48),
    Vector3.new(408.68, 34.45, 169.92),
    Vector3.new(335.75, 18.12, 205.47),
    Vector3.new(406.35, 33.01, 375.60),
    Vector3.new(359.39, 18.07, 437.61),
    Vector3.new(184.68, 18.11, 245.28),
    Vector3.new(312.79, 10.66, 351.58),
    Vector3.new(358.95, 18, 436.84),
    Vector3.new(358.95, 18, 436.84)
}

-- ========== 核心功能逻辑（保留原Killaura） ==========
-- 自动管道函数
local function performAutoPipeTeleport()
    local character = player.Character
    if not character then
        createNotification("角色未加载", Color3.fromRGB(200,50,50))
        return
    end
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then
        createNotification("根部件不存在", Color3.fromRGB(200,50,50))
        return
    end

    autoPipeButton.Text = "传送中..."
    createNotification("开始自动管道传送", Color3.fromRGB(50,200,50))

    local wasComboActive = isComboActive
    isComboActive = false
    comboButton.Text = "杀戮光环 [关]"

    local originalCFrame = rootPart.CFrame

    task.spawn(function()
        for i, pos in ipairs(allPipeLocations) do
            rootPart.CFrame = CFrame.new(pos)
            autoPipeButton.Text = string.format("进度: %d/18", i)
            RunService.Heartbeat:Wait()
        end
        rootPart.CFrame = originalCFrame
        if wasComboActive then
            isComboActive = true
            comboButton.Text = "杀戮光环 [开]"
        end
        autoPipeButton.Text = "自动管道"
        createNotification("自动管道传送完成", Color3.fromRGB(50,200,50))
        if isMinimized then statusLabel.Text = "✅ 管道传送完成" end
    end)
end

-- 杀戮光环函数
local function getNearestPlayer()
    local character = player.Character
    if not character then return nil end
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return nil end

    local nearestPlayer, nearestDist = nil, math.huge
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= player and p.Character then
            local targetRoot = p.Character:FindFirstChild("HumanoidRootPart")
            local humanoid = p.Character:FindFirstChild("Humanoid")
            if targetRoot and humanoid and humanoid.Health > 5 then
                local dist = (rootPart.Position - targetRoot.Position).Magnitude
                if dist < maxDistance and dist < nearestDist then
                    nearestDist = dist
                    nearestPlayer = p
                end
            end
        end
    end
    return nearestPlayer
end

local function performKillaura()
    if not isComboActive then
        comboNotifyFlag = false
        return
    end
    local nearest = getNearestPlayer()
    if not nearest then
        comboNotifyFlag = false
        comboButton.Text = "杀戮光环 [开]"
        if isMinimized then statusLabel.Text = " Monster\n未锁定目标" end
        return
    end

    local character = player.Character
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    local targetRoot = nearest.Character:FindFirstChild("HumanoidRootPart")
    if not rootPart or not targetRoot then return end

    rootPart.CFrame = CFrame.new(targetRoot.Position.X, targetRoot.Position.Y + teleportHeight, targetRoot.Position.Z)
    camera.CFrame = CFrame.lookAt(camera.CFrame.Position, targetRoot.Position)

    local currentTime = tick()
    if currentTime - lastAttackTime >= 1/attackRate then
        VirtualInputManager:SendMouseButtonEvent(0,0,0,true,game,0)
        task.wait(0.05)
        VirtualInputManager:SendMouseButtonEvent(0,0,0,false,game,0)
        lastAttackTime = currentTime
        if not comboNotifyFlag then
            createNotification("已锁定: "..nearest.Name, Color3.fromRGB(50,200,50))
            comboNotifyFlag = true
            if isMinimized then statusLabel.Text = " 锁定: "..string.sub(nearest.Name,1,6) end
        end
    end
    comboButton.Text = "锁定: "..string.sub(nearest.Name,1,6)
end

-- 轮流传送函数
local function performCycleTeleport()
    local character = player.Character
    if not character then return end
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end

    local validPlayers = {}
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            table.insert(validPlayers, p)
        end
    end
    if #validPlayers == 0 then
        createNotification("无有效玩家", Color3.fromRGB(200,50,50))
        return
    end
    cycleTeleportIndex = cycleTeleportIndex % #validPlayers + 1
    local target = validPlayers[cycleTeleportIndex]
    local targetRoot = target.Character:FindFirstChild("HumanoidRootPart")
    rootPart.CFrame = CFrame.new(targetRoot.Position.X, targetRoot.Position.Y + teleportHeight, targetRoot.Position.Z)
    createNotification("传送到: "..target.Name, Color3.fromRGB(50,200,50))
    if isMinimized then statusLabel.Text = "➡ 传送到: "..string.sub(target.Name,1,6) end
end

-- ========== UI交互逻辑（与 Monster完全一致） ==========
-- 缩放按钮
zoomBtn.MouseButton1Click:Connect(function()
    isZoomed = not isZoomed
    local targetSize = isZoomed and zoomedSize or originalSize
    TweenService:Create(mainFrame, TweenInfo.new(0.3), {Size = targetSize}):Play()
    zoomBtn.Text = isZoomed and "⏺" or "⏺️"
end)

-- 最小化按钮
minimizeBtn.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    if isMinimized then
        TweenService:Create(mainFrame, TweenInfo.new(0.3), {Size = minimizedSize}):Play()
        comboButton.Visible = false
        cycleTeleportButton.Visible = false
        autoPipeButton.Visible = false
        statusLabel.Visible = true
        minimizeBtn.Text = "+"
        -- 最小化后标题显示鸭子图片
        titleText.Visible = false
        titleImage.Size = UDim2.new(0, 20, 0, 20)
        titleImage.Position = UDim2.new(0.5, -10, 0, 2)
        if isComboActive then
            statusLabel.Text = " 杀戮光环开启"
        else
            statusLabel.Text = " Monster\n点击展开"
        end
    else
        comboButton.Visible = true
        cycleTeleportButton.Visible = true
        autoPipeButton.Visible = true
        statusLabel.Visible = false
        minimizeBtn.Text = "_"
        -- 恢复标题文字和图片位置
        titleText.Visible = true
        titleImage.Size = UDim2.new(0, 20, 0, 20)
        titleImage.Position = UDim2.new(0, 5, 0, 2)
        local targetSize = isZoomed and zoomedSize or originalSize
        TweenService:Create(mainFrame, TweenInfo.new(0.3), {Size = targetSize}):Play()
    end
end)

-- 关闭按钮
closeBtn.MouseButton1Click:Connect(function()
    TweenService:Create(mainFrame, TweenInfo.new(0.3), {
        BackgroundTransparency = 0.8,
        Position = mainFrame.Position + UDim2.new(0,0,0,-20)
    }):Play()
    task.wait(0.3)
    screenGui:Destroy()
    isRunning = false
    createNotification("Killaura面板已关闭", Color3.fromRGB(200,50,50))
end)

-- 功能按钮点击
comboButton.MouseButton1Click:Connect(function()
    isComboActive = not isComboActive
    comboButton.Text = isComboActive and "杀戮光环 [开]" or "杀戮光环 [关]"
    createNotification(isComboActive and "杀戮光环已开启" or "杀戮光环已关闭", isComboActive and Color3.fromRGB(50,200,50) or Color3.fromRGB(200,50,50))
    if isMinimized then statusLabel.Text = isComboActive and " 杀戮光环开启" or " Monster\n点击展开" end
end)
cycleTeleportButton.MouseButton1Click:Connect(performCycleTeleport)
autoPipeButton.MouseButton1Click:Connect(performAutoPipeTeleport)

-- 快捷键
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode.RightControl then
        isComboActive = not isComboActive
        comboButton.Text = isComboActive and "杀戮光环 [开]" or "杀戮光环 [关]"
        createNotification(isComboActive and "杀戮光环已开启" or "杀戮光环已关闭", isComboActive and Color3.fromRGB(50,200,50) or Color3.fromRGB(200,50,50))
        if isMinimized then statusLabel.Text = isComboActive and " 杀戮光环开启" or " Monster\n点击展开" end
    end
end)

-- 主循环
RunService.Heartbeat:Connect(function()
    if isRunning then performKillaura() end
end)

-- 初始淡入动画（ Monster同款）
mainFrame.BackgroundTransparency = 1
mainFrame.Position = UDim2.new(0.02,0,0.3,-30)
TweenService:Create(mainFrame, TweenInfo.new(0.5), {
    BackgroundTransparency = 0.1,
    Position = UDim2.new(0.02,0,0.3,0)
}):Play()
createNotification(" Monster Killaura面板已加载", Color3.fromRGB(50,200,50))