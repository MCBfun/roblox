-- killaura
local SoundService = game:GetService("SoundService")

-- 创建音频实例
local sound = Instance.new("Sound")
sound.SoundId = "rbxassetid://7390036132"  -- 替换为你的音频ID
sound.Parent = SoundService

-- 播放音频
sound:Play()

-- 极简自瞄+传送+攻击脚本 - 完整版（五合一功能） 
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local isRunning = true
local camera = Workspace.CurrentCamera

-- ESP相关变量
local espEnabled = false
local espFolder = Instance.new("Folder")
espFolder.Name = "ESP"
espFolder.Parent = game.CoreGui

-- 颜色定义
local espColors = {
    team = Color3.fromRGB(0, 255, 0),      -- 队友绿色
    enemy = Color3.fromRGB(255, 0, 0),     -- 敌人红色
    neutral = Color3.fromRGB(255, 255, 0)  -- 中立黄色
}

-- 创建最小化UI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "SimpleAimbotGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 120, 0, 255)  -- 增加高度以容纳五个按钮
mainFrame.Position = UDim2.new(0.02, 0, 0.3, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 55)
mainFrame.BackgroundTransparency = 0.2
mainFrame.BorderSizePixel = 1
mainFrame.BorderColor3 = Color3.fromRGB(80, 80, 100)
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.ClipsDescendants = true
mainFrame.Parent = screenGui

-- 圆角效果
local uiCorner = Instance.new("UICorner")
uiCorner.CornerRadius = UDim.new(0, 6)
uiCorner.Parent = mainFrame

-- 标题栏
local titleBar = Instance.new("Frame")
titleBar.Name = "TitleBar"
titleBar.Size = UDim2.new(1, 0, 0, 25)
titleBar.BackgroundColor3 = Color3.fromRGB(30, 30, 45)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

-- 标题栏圆角
local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 6)
titleCorner.Parent = titleBar

local title = Instance.new("TextLabel")
title.Text = "killaura"
title.Size = UDim2.new(1, -80, 1, 0)
title.Position = UDim2.new(0, 5, 0, 0)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextXAlignment = Enum.TextXAlignment.Left
title.Font = Enum.Font.SourceSansSemibold
title.TextSize = 14
title.Parent = titleBar

-- 控制按钮容器
local controlButtons = Instance.new("Frame")
controlButtons.Name = "ControlButtons"
controlButtons.Size = UDim2.new(0, 75, 1, 0)
controlButtons.Position = UDim2.new(1, -75, 0, 0)
controlButtons.BackgroundTransparency = 1
controlButtons.Parent = titleBar

-- 缩放按钮
local zoomBtn = Instance.new("TextButton")
zoomBtn.Name = "ZoomButton"
zoomBtn.Size = UDim2.new(0, 25, 0, 25)
zoomBtn.Position = UDim2.new(0, 0, 0, 0)
zoomBtn.Text = "⏺️"
zoomBtn.BackgroundColor3 = Color3.fromRGB(60, 100, 180)
zoomBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
zoomBtn.Font = Enum.Font.SourceSansBold
zoomBtn.TextSize = 14
zoomBtn.AutoButtonColor = false
zoomBtn.Parent = controlButtons

-- 缩小按钮
local minimizeBtn = Instance.new("TextButton")
minimizeBtn.Name = "MinimizeButton"
minimizeBtn.Size = UDim2.new(0, 25, 0, 25)
minimizeBtn.Position = UDim2.new(0, 25, 0, 0)
minimizeBtn.Text = "_"
minimizeBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
minimizeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
minimizeBtn.Font = Enum.Font.SourceSansBold
minimizeBtn.TextSize = 16
minimizeBtn.AutoButtonColor = false
minimizeBtn.Parent = controlButtons

-- 关闭按钮
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 25, 0, 25)
closeBtn.Position = UDim2.new(0, 50, 0, 0)
closeBtn.Text = "×"
closeBtn.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
closeBtn.Font = Enum.Font.SourceSansBold
closeBtn.TextSize = 16
closeBtn.AutoButtonColor = false
closeBtn.Parent = controlButtons

-- 四个功能按钮
local comboButton = Instance.new("TextButton")
comboButton.Name = "ComboButton"
comboButton.Size = UDim2.new(1, -10, 0, 40)
comboButton.Position = UDim2.new(0, 5, 0, 30)
comboButton.Text = "killaura"
comboButton.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
comboButton.TextColor3 = Color3.fromRGB(255, 255, 255)
comboButton.Font = Enum.Font.SourceSansSemibold
comboButton.TextSize = 14
comboButton.TextWrapped = true
comboButton.AutoButtonColor = false
comboButton.Parent = mainFrame

local comboCorner = Instance.new("UICorner")
comboCorner.CornerRadius = UDim.new(0, 5)
comboCorner.Parent = comboButton

-- 轮流传送按钮
local cycleTeleportButton = Instance.new("TextButton")
cycleTeleportButton.Name = "CycleTeleportButton"
cycleTeleportButton.Size = UDim2.new(1, -10, 0, 40)
cycleTeleportButton.Position = UDim2.new(0, 5, 0, 75)
cycleTeleportButton.Text = "轮流传送\n下一个玩家"
cycleTeleportButton.BackgroundColor3 = Color3.fromRGB(60, 100, 180)
cycleTeleportButton.TextColor3 = Color3.fromRGB(255, 255, 255)
cycleTeleportButton.Font = Enum.Font.SourceSansSemibold
cycleTeleportButton.TextSize = 14
cycleTeleportButton.TextWrapped = true
cycleTeleportButton.AutoButtonColor = false
cycleTeleportButton.Parent = mainFrame

local teleportCorner = Instance.new("UICorner")
teleportCorner.CornerRadius = UDim.new(0, 5)
teleportCorner.Parent = cycleTeleportButton

-- 工厂传送按钮
local factoryLocations = {
    {X = 314.57, Y = 10.58, Z = 350.95},
    {X = 387, Y = 7.48, Z = 331.22},
    {X = 335.74, Y = 18.14, Z = 206},
    {X = 184.17, Y = 18, Z = 244.44},
    {X = 405.2, Y = 33, Z = 374.88},
    {X = 358.95, Y = 18, Z = 436.84}
}

local factoryTeleportButton = Instance.new("TextButton")
factoryTeleportButton.Name = "FactoryTeleportButton"
factoryTeleportButton.Size = UDim2.new(1, -10, 0, 40)
factoryTeleportButton.Position = UDim2.new(0, 5, 0, 120)
factoryTeleportButton.Text = "工厂自动管道"
factoryTeleportButton.BackgroundColor3 = Color3.fromRGB(180, 100, 60)
factoryTeleportButton.TextColor3 = Color3.fromRGB(255, 255, 255)
factoryTeleportButton.Font = Enum.Font.SourceSansSemibold
factoryTeleportButton.TextSize = 14
factoryTeleportButton.TextWrapped = true
factoryTeleportButton.AutoButtonColor = false
factoryTeleportButton.Parent = mainFrame

local factoryCorner = Instance.new("UICorner")
factoryCorner.CornerRadius = UDim.new(0, 5)
factoryCorner.Parent = factoryTeleportButton

-- 剧院传送按钮
local theaterLocations = {
    {X = -15.25, Y = 87.42, Z = -455.5},
    {X = 13.54, Y = 94.18, Z = -531.25},
    {X = -1.22, Y = 71, Z = -329.23},
    {X = 43.73, Y = 68.93, Z = -254.27},
    {X = -61.2, Y = 105.1, Z = -158.37},
    {X = 33.67, Y = 60.16, Z = -472}
}

local theaterTeleportButton = Instance.new("TextButton")
theaterTeleportButton.Name = "TheaterTeleportButton"
theaterTeleportButton.Size = UDim2.new(1, -10, 0, 40)
theaterTeleportButton.Position = UDim2.new(0, 5, 0, 165)
theaterTeleportButton.Text = "剧院自动管道"
theaterTeleportButton.BackgroundColor3 = Color3.fromRGB(100, 60, 180)
theaterTeleportButton.TextColor3 = Color3.fromRGB(255, 255, 255)
theaterTeleportButton.Font = Enum.Font.SourceSansSemibold
theaterTeleportButton.TextSize = 14
theaterTeleportButton.TextWrapped = true
theaterTeleportButton.AutoButtonColor = false
theaterTeleportButton.Parent = mainFrame

local theaterCorner = Instance.new("UICorner")
theaterCorner.CornerRadius = UDim.new(0, 5)
theaterCorner.Parent = theaterTeleportButton

-- ESP按钮
local espButton = Instance.new("TextButton")
espButton.Name = "ESPButton"
espButton.Size = UDim2.new(1, -10, 0, 40)
espButton.Position = UDim2.new(0, 5, 0, 210)
espButton.Text = "ESP\n透视显示"
espButton.BackgroundColor3 = Color3.fromRGB(60, 180, 100)  -- 绿色
espButton.TextColor3 = Color3.fromRGB(255, 255, 255)
espButton.Font = Enum.Font.SourceSansSemibold
espButton.TextSize = 14
espButton.TextWrapped = true
espButton.AutoButtonColor = false
espButton.Parent = mainFrame

local espCorner = Instance.new("UICorner")
espCorner.CornerRadius = UDim.new(0, 5)
espCorner.Parent = espButton

-- 状态显示
local statusLabel = Instance.new("TextLabel")
statusLabel.Name = "StatusLabel"
statusLabel.Size = UDim2.new(1, -10, 1, -10)
statusLabel.Position = UDim2.new(0, 5, 0, 5)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "killaura\n点击展开"
statusLabel.TextColor3 = Color3.fromRGB(200, 200, 220)
statusLabel.TextSize = 12
statusLabel.TextWrapped = true
statusLabel.Visible = false
statusLabel.Parent = mainFrame

-- 变量
local isComboActive = false
local maxDistance = 200
local teleportHeight = 0
local currentTarget = nil
local lastAttackTime = 0
local attackRate = 4
local isMinimized = false
local isZoomed = false
local originalSize = mainFrame.Size
local originalPosition = mainFrame.Position
local minimizedSize = UDim2.new(0, 80, 0, 40)
local zoomedSize = UDim2.new(0, 140, 0, 270)  -- 调整放大尺寸
local ignoreHealthThreshold = 5

-- 传送相关变量
local cycleTeleportIndex = 1
local factoryTeleportIndex = 1
local theaterTeleportIndex = 1

-- ESP存储表
local espObjects = {}

-- 按钮悬停效果函数
local function setupButtonHover(button)
    local originalColor = button.BackgroundColor3
    button.MouseEnter:Connect(function()
        button.BackgroundColor3 = Color3.fromRGB(
            math.min(originalColor.R * 255 * 1.2, 255),
            math.min(originalColor.G * 255 * 1.2, 255),
            math.min(originalColor.B * 255 * 1.2, 255)
        ) / 255
    end)
    button.MouseLeave:Connect(function()
        button.BackgroundColor3 = originalColor
    end)
end

-- 应用悬停效果
setupButtonHover(comboButton)
setupButtonHover(cycleTeleportButton)
setupButtonHover(factoryTeleportButton)
setupButtonHover(theaterTeleportButton)
setupButtonHover(espButton)
setupButtonHover(zoomBtn)
setupButtonHover(minimizeBtn)
setupButtonHover(closeBtn)

-- 缩放功能
zoomBtn.MouseButton1Click:Connect(function()
    isZoomed = not isZoomed
    if isZoomed then
        mainFrame:TweenSize(zoomedSize, Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.3, true)
        zoomBtn.Text = "⏺"
    else
        mainFrame:TweenSize(originalSize, Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.3, true)
        zoomBtn.Text = "⏺️"
    end
end)

-- 缩小功能
minimizeBtn.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    if isMinimized then
        comboButton.Visible = false
        cycleTeleportButton.Visible = false
        factoryTeleportButton.Visible = false
        theaterTeleportButton.Visible = false
        espButton.Visible = false
        statusLabel.Visible = true
        mainFrame:TweenSize(minimizedSize, Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.3, true)
        minimizeBtn.Text = "+"
    else
        comboButton.Visible = true
        cycleTeleportButton.Visible = true
        factoryTeleportButton.Visible = true
        theaterTeleportButton.Visible = true
        espButton.Visible = true
        statusLabel.Visible = false
        mainFrame:TweenSize(isZoomed and zoomedSize or originalSize, Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.3, true)
        minimizeBtn.Text = "_"
    end
end)

-- 关闭功能
closeBtn.MouseButton1Click:Connect(function()
    local tween = TweenService:Create(mainFrame, TweenInfo.new(0.3), {
        BackgroundTransparency = 0.8,
        Position = mainFrame.Position + UDim2.new(0, 0, 0, -20)
    })
    tween:Play()
    tween.Completed:Wait()
    screenGui:Destroy()
    espFolder:Destroy()
    isRunning = false
end)

-- 三合一按钮功能
comboButton.MouseButton1Click:Connect(function()
    isComboActive = not isComboActive
    if isComboActive then
        comboButton.BackgroundColor3 = Color3.fromRGB(60, 180, 60)
        comboButton.Text = "killaura\n[ON]"
    else
        comboButton.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
        comboButton.Text = "killaura\n[OFF]"
    end
end)

-- ESP按钮功能
espButton.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    if espEnabled then
        espButton.BackgroundColor3 = Color3.fromRGB(30, 150, 70)
        espButton.Text = "ESP透视\n[ON]"
        createESPForAllPlayers()
    else
        espButton.BackgroundColor3 = Color3.fromRGB(60, 180, 100)
        espButton.Text = "ESP透视\n[OFF]"
        clearESP()
    end
end)

-- 获取玩家当前血量
local function getPlayerHealth(targetCharacter)
    local humanoid = targetCharacter:FindFirstChild("Humanoid")
    if humanoid then
        return humanoid.Health
    end
    return 100
end

-- 获取所有有效玩家列表
local function getValidPlayers()
    local validPlayers = {}
    for _, otherPlayer in pairs(Players:GetPlayers()) do
        if otherPlayer ~= player and otherPlayer.Character then
            local humanoid = otherPlayer.Character:FindFirstChild("Humanoid")
            if humanoid and humanoid.Health > ignoreHealthThreshold then
                table.insert(validPlayers, otherPlayer)
            end
        end
    end
    return validPlayers
end

-- 获取最近玩家
local function getNearestPlayer()
    local character = player.Character
    if not character then return nil end
    
    local validPlayers = getValidPlayers()
    local nearestPlayer = nil
    local nearestDistance = math.huge
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    
    if not rootPart then return nil end
    
    for _, otherPlayer in pairs(validPlayers) do
        local otherCharacter = otherPlayer.Character
        if otherCharacter then
            local otherRoot = otherCharacter:FindFirstChild("HumanoidRootPart")
            if otherRoot then
                local distance = (rootPart.Position - otherRoot.Position).Magnitude
                if distance < maxDistance and distance < nearestDistance then
                    nearestDistance = distance
                    nearestPlayer = otherPlayer
                end
            end
        end
    end
    
    return nearestPlayer
end

-- 创建ESP显示
local function createESP(player)
    if espObjects[player] then
        return
    end
    
    local character = player.Character
    if not character then return end
    
    local espTable = {}
    
    -- 创建高亮框
    local highlight = Instance.new("Highlight")
    highlight.Name = player.Name .. "_ESP"
    highlight.Adornee = character
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.FillTransparency = 0.8
    highlight.OutlineTransparency = 0
    highlight.Parent = espFolder
    
    -- 设置颜色
    local teamColor = espColors.enemy  -- 默认敌人红色
    if player.Team and player.Team == player.Team then
        teamColor = espColors.team  -- 队友绿色
    end
    
    highlight.FillColor = teamColor
    highlight.OutlineColor = teamColor
    
    -- 创建距离文本
    local distanceText = Instance.new("BillboardGui")
    distanceText.Name = player.Name .. "_Distance"
    distanceText.Adornee = character:FindFirstChild("Head") or character:FindFirstChild("HumanoidRootPart")
    distanceText.Size = UDim2.new(0, 200, 0, 50)
    distanceText.StudsOffset = Vector3.new(0, 3, 0)
    distanceText.AlwaysOnTop = true
    distanceText.Enabled = true
    distanceText.Parent = espFolder
    
    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = teamColor
    textLabel.TextStrokeTransparency = 0.5
    textLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    textLabel.Font = Enum.Font.SourceSansBold
    textLabel.TextSize = 18
    textLabel.Text = player.Name
    textLabel.Parent = distanceText
    
    espTable.highlight = highlight
    espTable.distanceText = distanceText
    espTable.textLabel = textLabel
    espObjects[player] = espTable
    
    -- 玩家角色变化时更新
    player.CharacterAdded:Connect(function(newChar)
        task.wait(0.5)
        if espEnabled and espObjects[player] then
            espObjects[player].highlight.Adornee = newChar
            local adornment = newChar:FindFirstChild("Head") or newChar:FindFirstChild("HumanoidRootPart")
            if adornment then
                espObjects[player].distanceText.Adornee = adornment
            end
        end
    end)
end

-- 为所有玩家创建ESP
local function createESPForAllPlayers()
    clearESP()
    
    for _, otherPlayer in pairs(Players:GetPlayers()) do
        if otherPlayer ~= player then
            if otherPlayer.Character then
                createESP(otherPlayer)
            end
            otherPlayer.CharacterAdded:Connect(function()
                if espEnabled then
                    task.wait(0.5)
                    createESP(otherPlayer)
                end
            end)
        end
    end
end

-- 清除ESP
local function clearESP()
    for playerName, espTable in pairs(espObjects) do
        if espTable.highlight then
            espTable.highlight:Destroy()
        end
        if espTable.distanceText then
            espTable.distanceText:Destroy()
        end
    end
    espObjects = {}
end

-- 更新ESP距离
local function updateESP()
    if not espEnabled then return end
    
    local character = player.Character
    if not character then return end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end
    
    for otherPlayer, espTable in pairs(espObjects) do
        if otherPlayer and otherPlayer.Character then
            local otherRoot = otherPlayer.Character:FindFirstChild("HumanoidRootPart")
            if otherRoot and espTable.textLabel then
                local distance = (rootPart.Position - otherRoot.Position).Magnitude
                local health = getPlayerHealth(otherPlayer.Character)
                
                -- 更新文本显示
                espTable.textLabel.Text = string.format("%s\n%d HP | %dm", 
                    otherPlayer.Name, 
                    math.floor(health), 
                    math.floor(distance))
                
                -- 根据距离调整颜色
                if distance < 20 then
                    espTable.textLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
                elseif distance < 50 then
                    espTable.textLabel.TextColor3 = Color3.fromRGB(255, 165, 0)
                else
                    espTable.textLabel.TextColor3 = espTable.textLabel.TextColor3
                end
            end
        end
    end
end

-- 执行轮流传送
local function performCycleTeleport()
    local character = player.Character
    if not character then return end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end
    
    local validPlayers = getValidPlayers()
    if #validPlayers == 0 then
        cycleTeleportButton.Text = "无有效玩家"
        task.wait(1)
        cycleTeleportButton.Text = "轮流传送\n下一个玩家"
        return
    end
    
    local targetPlayer = validPlayers[cycleTeleportIndex]
    if targetPlayer and targetPlayer.Character then
        local targetRoot = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
        if targetRoot then
            rootPart.CFrame = CFrame.new(
                targetRoot.Position.X,
                targetRoot.Position.Y + teleportHeight,
                targetRoot.Position.Z
            )
            
            cycleTeleportButton.Text = "传送至: " .. string.sub(targetPlayer.Name, 1, 8)
            task.wait(1)
            cycleTeleportButton.Text = "轮流传送\n下一个玩家"
        end
    end
    
    cycleTeleportIndex = cycleTeleportIndex + 1
    if cycleTeleportIndex > #validPlayers then
        cycleTeleportIndex = 1
    end
end

-- 执行工厂传送
local function performFactoryTeleport()
    local character = player.Character
    if not character then return end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end
    
    local location = factoryLocations[factoryTeleportIndex]
    if location then
        rootPart.CFrame = CFrame.new(location.X, location.Y, location.Z)
        
        factoryTeleportButton.Text = string.format("工厂传送 %d/%d", factoryTeleportIndex, #factoryLocations)
        task.wait(1)
        factoryTeleportButton.Text = "工厂自动管道"
    end
    
    factoryTeleportIndex = factoryTeleportIndex + 1
    if factoryTeleportIndex > #factoryLocations then
        factoryTeleportIndex = 1
    end
end

-- 执行剧院传送
local function performTheaterTeleport()
    local character = player.Character
    if not character then return end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end
    
    local location = theaterLocations[theaterTeleportIndex]
    if location then
        rootPart.CFrame = CFrame.new(location.X, location.Y, location.Z)
        
        theaterTeleportButton.Text = string.format("剧院传送 %d/%d", theaterTeleportIndex, #theaterLocations)
        task.wait(1)
        theaterTeleportButton.Text = "剧院自动管道"
    end
    
    theaterTeleportIndex = theaterTeleportIndex + 1
    if theaterTeleportIndex > #theaterLocations then
        theaterTeleportIndex = 1
    end
end

-- 执行三合一功能
local function performCombo()
    if not isComboActive then return false end
    
    local character = player.Character
    if not character then return false end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return false end
    
    local nearestPlayer = getNearestPlayer()
    if not nearestPlayer then return false end
    
    local targetCharacter = nearestPlayer.Character
    if not targetCharacter then return false end
    
    local targetRoot = targetCharacter:FindFirstChild("HumanoidRootPart")
    if not targetRoot then return false end
    
    -- 1. 传送
    rootPart.CFrame = CFrame.new(
        targetRoot.Position.X,
        targetRoot.Position.Y + teleportHeight,
        targetRoot.Position.Z
    )
    
    -- 2. 自瞄
    camera.CFrame = CFrame.lookAt(camera.CFrame.Position, targetRoot.Position)
    
    -- 3. 攻击
    local currentTime = tick()
    if currentTime - lastAttackTime >= (1 / attackRate) then
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
        task.wait(0.05)
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
        lastAttackTime = currentTime
    end
    
    currentTarget = nearestPlayer
    comboButton.Text = "killaura\n锁定: " .. string.sub(nearestPlayer.Name, 1, 8)
    
    return true
end

-- 按钮点击事件
cycleTeleportButton.MouseButton1Click:Connect(function()
    performCycleTeleport()
end)

factoryTeleportButton.MouseButton1Click:Connect(function()
    performFactoryTeleport()
end)

theaterTeleportButton.MouseButton1Click:Connect(function()
    performTheaterTeleport()
end)

-- 主循环
RunService.Heartbeat:Connect(function()
    if not isRunning then return end
    
    -- 更新ESP
    updateESP()
    
    -- 执行三合一功能
    performCombo()
end)

-- 快捷键
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == Enum.KeyCode.RightControl then
        isComboActive = not isComboActive
        if isComboActive then
            comboButton.BackgroundColor3 = Color3.fromRGB(60, 180, 60)
            comboButton.Text = "killaura\n[ON]"
        else
            comboButton.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
            comboButton.Text = "killaura\n[OFF]"
        end
    elseif input.KeyCode == Enum.KeyCode.Insert then
        espEnabled = not espEnabled
        if espEnabled then
            espButton.BackgroundColor3 = Color3.fromRGB(30, 150, 70)
            espButton.Text = "ESP透视\n[ON]"
            createESPForAllPlayers()
        else
            espButton.BackgroundColor3 = Color3.fromRGB(60, 180, 100)
            espButton.Text = "ESP透视\n[OFF]"
            clearESP()
        end
    end
end)

-- 玩家加入和离开时更新ESP
Players.PlayerAdded:Connect(function(newPlayer)
    if espEnabled then
        newPlayer.CharacterAdded:Connect(function()
            task.wait(0.5)
            createESP(newPlayer)
        end)
    end
end)

Players.PlayerRemoving:Connect(function(leavingPlayer)
    if espObjects[leavingPlayer] then
        if espObjects[leavingPlayer].highlight then
            espObjects[leavingPlayer].highlight:Destroy()
        end
        if espObjects[leavingPlayer].distanceText then
            espObjects[leavingPlayer].distanceText:Destroy()
        end
        espObjects[leavingPlayer] = nil
    end
end)

-- 初始淡入动画
mainFrame.BackgroundTransparency = 1
mainFrame.Position = originalPosition + UDim2.new(0, 0, 0, -30)

task.wait(0.1)

local fadeInTween = TweenService:Create(mainFrame, TweenInfo.new(0.5), {
    BackgroundTransparency = 0.2,
    Position = originalPosition
})
fadeInTween:Play()

game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "Cheating",
    Text = "成功加载ESP功能",
    Icon = "rbxassetid://14550088217",
    Duration = 8,
    Position = UDim2.new(0, 20, 1, -50)
})
-- ==================== 添加ESP功能 ====================
-- 在现有脚本的最后添加以下代码

-- ESP变量
local espEnabled = false
local espFolder = Instance.new("Folder")
espFolder.Name = "ESP"
espFolder.Parent = game.CoreGui

-- 颜色定义
local espColors = {
    team = Color3.fromRGB(0, 255, 0),      -- 队友绿色
    enemy = Color3.fromRGB(255, 0, 0),     -- 敌人红色
    neutral = Color3.fromRGB(255, 255, 0)  -- 中立黄色
}

-- ESP存储表
local espObjects = {}

-- 创建ESP按钮（添加到现有按钮下方）
local espButton = Instance.new("TextButton")
espButton.Name = "ESPButton"
espButton.Size = UDim2.new(1, -10, 0, 40)
espButton.Position = UDim2.new(0, 5, 0, 210)  -- 调整这个位置让它显示在正确位置
espButton.Text = "ESP透视\n[OFF]"
espButton.BackgroundColor3 = Color3.fromRGB(60, 180, 100)  -- 绿色
espButton.TextColor3 = Color3.fromRGB(255, 255, 255)
espButton.Font = Enum.Font.SourceSansSemibold
espButton.TextSize = 14
espButton.TextWrapped = true
espButton.AutoButtonColor = false
espButton.Parent = mainFrame

-- 添加圆角
local espCorner = Instance.new("UICorner")
espCorner.CornerRadius = UDim.new(0, 5)
espCorner.Parent = espButton

-- 调整mainFrame大小以适应新按钮（如果之前大小不够）
mainFrame.Size = UDim2.new(0, 120, 0, 255)

-- 更新缩小和放大的尺寸
minimizedSize = UDim2.new(0, 80, 0, 40)
zoomedSize = UDim2.new(0, 140, 0, 270)

-- 为ESP按钮添加悬停效果
local function setupESPButtonHover(button)
    local originalColor = button.BackgroundColor3
    button.MouseEnter:Connect(function()
        button.BackgroundColor3 = Color3.fromRGB(
            math.min(originalColor.R * 255 * 1.2, 255),
            math.min(originalColor.G * 255 * 1.2, 255),
            math.min(originalColor.B * 255 * 1.2, 255)
        ) / 255
    end)
    button.MouseLeave:Connect(function()
        button.BackgroundColor3 = originalColor
    end)
end

setupESPButtonHover(espButton)

-- 创建ESP显示
local function createESP(player)
    if espObjects[player] then
        return
    end
    
    local character = player.Character
    if not character then return end
    
    -- 等待角色完全加载
    task.wait(0.5)
    
    local espTable = {}
    
    -- 创建高亮框
    local highlight = Instance.new("Highlight")
    highlight.Name = player.Name .. "_ESP"
    highlight.Adornee = character
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.FillTransparency = 0.85
    highlight.OutlineTransparency = 0.1
    highlight.FillColor = Color3.fromRGB(255, 0, 0)  -- 红色
    highlight.OutlineColor = Color3.fromRGB(255, 255, 255)  -- 白色边框
    highlight.Parent = espFolder
    
    -- 创建距离文本
    local distanceText = Instance.new("BillboardGui")
    distanceText.Name = player.Name .. "_Distance"
    local adornment = character:FindFirstChild("Head") or character:FindFirstChild("HumanoidRootPart")
    if adornment then
        distanceText.Adornee = adornment
    end
    distanceText.Size = UDim2.new(0, 200, 0, 50)
    distanceText.StudsOffset = Vector3.new(0, 3.5, 0)
    distanceText.AlwaysOnTop = true
    distanceText.Enabled = true
    distanceText.Parent = espFolder
    
    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = Color3.fromRGB(255, 255, 255)  -- 白色文字
    textLabel.TextStrokeTransparency = 0.3
    textLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    textLabel.Font = Enum.Font.SourceSansBold
    textLabel.TextSize = 16
    textLabel.Text = player.Name
    textLabel.Parent = distanceText
    
    espTable.highlight = highlight
    espTable.distanceText = distanceText
    espTable.textLabel = textLabel
    espObjects[player] = espTable
    
    -- 玩家角色变化时更新
    player.CharacterAdded:Connect(function(newChar)
        task.wait(0.5)
        if espEnabled and espObjects[player] then
            espObjects[player].highlight.Adornee = newChar
            local newAdornment = newChar:FindFirstChild("Head") or newChar:FindFirstChild("HumanoidRootPart")
            if newAdornment then
                espObjects[player].distanceText.Adornee = newAdornment
            end
        end
    end)
end

-- 为所有玩家创建ESP
local function createESPForAllPlayers()
    -- 先清除旧的ESP
    for playerName, espTable in pairs(espObjects) do
        if espTable.highlight then
            espTable.highlight:Destroy()
        end
        if espTable.distanceText then
            espTable.distanceText:Destroy()
        end
    end
    espObjects = {}
    
    -- 为新玩家创建ESP
    for _, otherPlayer in pairs(Players:GetPlayers()) do
        if otherPlayer ~= player then
            if otherPlayer.Character then
                createESP(otherPlayer)
            end
            otherPlayer.CharacterAdded:Connect(function()
                if espEnabled then
                    createESP(otherPlayer)
                end
            end)
        end
    end
end

-- 清除ESP
local function clearESP()
    for playerName, espTable in pairs(espObjects) do
        if espTable.highlight then
            espTable.highlight:Destroy()
        end
        if espTable.distanceText then
            espTable.distanceText:Destroy()
        end
    end
    espObjects = {}
end

-- 更新ESP距离
local function updateESP()
    if not espEnabled then return end
    
    local character = player.Character
    if not character then return end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end
    
    for otherPlayer, espTable in pairs(espObjects) do
        if otherPlayer and otherPlayer.Character and espTable.textLabel then
            local otherRoot = otherPlayer.Character:FindFirstChild("HumanoidRootPart")
            if otherRoot then
                local distance = (rootPart.Position - otherRoot.Position).Magnitude
                local health = 100
                local humanoid = otherPlayer.Character:FindFirstChild("Humanoid")
                if humanoid then
                    health = math.floor(humanoid.Health)
                end
                
                -- 更新文本显示
                espTable.textLabel.Text = string.format("%s\n%d HP | %dm", 
                    otherPlayer.Name, 
                    health, 
                    math.floor(distance))
                
                -- 根据血量调整颜色
                if health < 30 then
                    espTable.highlight.FillColor = Color3.fromRGB(255, 255, 0)  -- 黄色
                    espTable.highlight.OutlineColor = Color3.fromRGB(255, 255, 0)
                elseif health < 60 then
                    espTable.highlight.FillColor = Color3.fromRGB(255, 165, 0)  -- 橙色
                    espTable.highlight.OutlineColor = Color3.fromRGB(255, 165, 0)
                else
                    espTable.highlight.FillColor = Color3.fromRGB(255, 0, 0)    -- 红色
                    espTable.highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
                end
            end
        end
    end
end

-- ESP按钮点击事件
espButton.MouseButton1Click:Connect(function()
    espEnabled = not espEnabled
    if espEnabled then
        espButton.BackgroundColor3 = Color3.fromRGB(30, 150, 70)  -- 深绿色
        espButton.Text = "ESP透视\n[ON]"
        createESPForAllPlayers()
        print("ESP功能已启用")
    else
        espButton.BackgroundColor3 = Color3.fromRGB(60, 180, 100)  -- 亮绿色
        espButton.Text = "ESP透视\n[OFF]"
        clearESP()
        print("ESP功能已禁用")
    end
end)

-- 更新主循环以包含ESP更新
local originalHeartbeat = RunService.Heartbeat:Connect(function() end) -- 保存原始连接
originalHeartbeat:Disconnect() -- 断开原始连接

-- 重新连接主循环（包含ESP更新）
RunService.Heartbeat:Connect(function()
    if not isRunning then return end
    
    -- 更新ESP
    updateESP()
    
    -- 原有的三合一功能
    if not isComboActive then return end
    
    local character = player.Character
    if not character then return end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end
    
    local nearestPlayer = getNearestPlayer()
    if not nearestPlayer then 
        comboButton.Text = "killaura\n无目标"
        return 
    end
    
    local targetCharacter = nearestPlayer.Character
    if not targetCharacter then return end
    
    local targetRoot = targetCharacter:FindFirstChild("HumanoidRootPart")
    if not targetRoot then return end
    
    -- 1. 传送
    rootPart.CFrame = CFrame.new(
        targetRoot.Position.X,
        targetRoot.Position.Y + teleportHeight,
        targetRoot.Position.Z
    )
    
    -- 2. 自瞄
    camera.CFrame = CFrame.lookAt(camera.CFrame.Position, targetRoot.Position)
    
    -- 3. 攻击
    local currentTime = tick()
    if currentTime - lastAttackTime >= (1 / attackRate) then
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
        task.wait(0.05)
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
        lastAttackTime = currentTime
    end
    
    currentTarget = nearestPlayer
    comboButton.Text = "killaura\n锁定: " .. string.sub(nearestPlayer.Name, 1, 8)
end)

-- 玩家加入和离开时更新ESP
Players.PlayerAdded:Connect(function(newPlayer)
    if espEnabled then
        newPlayer.CharacterAdded:Connect(function()
            task.wait(0.5)
            createESP(newPlayer)
        end)
    end
end)

Players.PlayerRemoving:Connect(function(leavingPlayer)
    if espObjects[leavingPlayer] then
        if espObjects[leavingPlayer].highlight then
            espObjects[leavingPlayer].highlight:Destroy()
        end
        if espObjects[leavingPlayer].distanceText then
            espObjects[leavingPlayer].distanceText:Destroy()
        end
        espObjects[leavingPlayer] = nil
    end
end)

-- 添加快捷键支持（Insert键开关ESP）
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == Enum.KeyCode.Insert then
        espEnabled = not espEnabled
        if espEnabled then
            espButton.BackgroundColor3 = Color3.fromRGB(30, 150, 70)
            espButton.Text = "ESP透视\n[ON]"
            createESPForAllPlayers()
            print("Insert键：ESP功能已启用")
        else
            espButton.BackgroundColor3 = Color3.fromRGB(60, 180, 100)
            espButton.Text = "ESP透视\n[OFF]"
            clearESP()
            print("Insert键：ESP功能已禁用")
        end
    end
end)


game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "Green Monster",
    Text = "渔炒鱼",
    Icon = "rbxassetid://14550088217",
    Duration = 5,
    Position = UDim2.new(0, 20, 1, -50)
})