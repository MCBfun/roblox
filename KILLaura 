-- killaura
local SoundService = game:GetService("SoundService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")

-- 音频初始化
local sound = Instance.new("Sound")
sound.SoundId = "rbxassetid://7390036132"
sound.Parent = SoundService
sound:Play()

local player = Players.LocalPlayer
local isRunning = true
local camera = Workspace.CurrentCamera
local comboNotifyFlag = false

-- UI创建（精简冗余代码）
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "SimpleAimbotGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

-- 提示框函数（保持防抖）
local function createNotification(text, color)
    local existingNotify = player.PlayerGui:FindFirstChild("KillauraNotify")
    if existingNotify then existingNotify:Destroy() end
    local notifyGui = Instance.new("ScreenGui", player.PlayerGui)
    notifyGui.Name = "KillauraNotify"
    notifyGui.IgnoreGuiInset = true
    
    local notifyFrame = Instance.new("Frame", notifyGui)
    notifyFrame.Size = UDim2.new(0,220,0,60)
    notifyFrame.Position = UDim2.new(1,-230,1,-90)
    notifyFrame.BackgroundColor3 = Color3.fromRGB(25,25,30)
    notifyFrame.BackgroundTransparency = 0.1
    Instance.new("UICorner", notifyFrame).CornerRadius = UDim.new(0,8)
    Instance.new("UIStroke", notifyFrame).Color = color or Color3.fromRGB(60,60,70)
    
    local notifyLabel = Instance.new("TextLabel", notifyFrame)
    notifyLabel.Size = UDim2.new(1,-10,1,-10)
    notifyLabel.Position = UDim2.new(0,5,0,5)
    notifyLabel.BackgroundTransparency = 1
    notifyLabel.Text = text
    notifyLabel.TextColor3 = Color3.fromRGB(240,240,240)
    notifyLabel.TextSize = 14
    notifyLabel.TextWrapped = true
    notifyLabel.Font = Enum.Font.SourceSansSemibold

    -- 淡入动画
    notifyFrame.BackgroundTransparency = 1
    notifyFrame.Position = UDim2.new(1,-200,1,-90)
    TweenService:Create(notifyFrame, TweenInfo.new(0.1), {
        BackgroundTransparency = 0.1,
        Position = UDim2.new(1,-230,1,-90)
    }):Play()

    task.delay(3, function()
        TweenService:Create(notifyFrame, TweenInfo.new(0.3), {
            BackgroundTransparency = 1,
            Position = UDim2.new(1,-200,1,-90)
        }):Play()
        task.wait(0.3)
        notifyGui:Destroy()
    end)
end

-- 主面板
local mainFrame = Instance.new("Frame", screenGui)
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0,120,0,210)
mainFrame.Position = UDim2.new(0.02,0,0.3,0)
mainFrame.BackgroundColor3 = Color3.fromRGB(25,25,30)
mainFrame.BackgroundTransparency = 0.1
mainFrame.BorderSizePixel = 1
mainFrame.BorderColor3 = Color3.fromRGB(60,60,70)
mainFrame.Active = true
mainFrame.Draggable = true
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0,6)

-- 标题栏
local titleBar = Instance.new("Frame", mainFrame)
titleBar.Size = UDim2.new(1,0,0,25)
titleBar.BackgroundColor3 = Color3.fromRGB(20,20,25)
Instance.new("UICorner", titleBar).CornerRadius = UDim.new(0,6)

local title = Instance.new("TextLabel", titleBar)
title.Text = "killaura"
title.Size = UDim2.new(1,-80,1,0)
title.Position = UDim2.new(0,5,0,0)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.fromRGB(220,220,220)
title.TextXAlignment = Enum.TextXAlignment.Left
title.Font = Enum.Font.SourceSansSemibold
title.TextSize = 14

-- 控制按钮（缩放/最小化/关闭）
local controlButtons = Instance.new("Frame", titleBar)
controlButtons.Size = UDim2.new(0,75,1,0)
controlButtons.Position = UDim2.new(1,-75,0,0)
controlButtons.BackgroundTransparency = 1

local function createCtrlBtn(parent, pos, text, color)
    local btn = Instance.new("TextButton", parent)
    btn.Size = UDim2.new(0,25,0,25)
    btn.Position = pos
    btn.Text = text
    btn.BackgroundColor3 = color
    btn.TextColor3 = Color3.fromRGB(220,220,220)
    btn.Font = Enum.Font.SourceSansBold
    btn.TextSize = 14
    btn.AutoButtonColor = false
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0,4)
    return btn
end

local zoomBtn = createCtrlBtn(controlButtons, UDim2.new(0,0,0,0), "⏺️", Color3.fromRGB(40,40,45))
local minimizeBtn = createCtrlBtn(controlButtons, UDim2.new(0,25,0,0), "_", Color3.fromRGB(40,40,45))
local closeBtn = createCtrlBtn(controlButtons, UDim2.new(0,50,0,0), "×", Color3.fromRGB(45,35,35))

-- 功能按钮
local function createFuncBtn(parent, pos, text)
    local btn = Instance.new("TextButton", parent)
    btn.Size = UDim2.new(1,-10,0,40)
    btn.Position = pos
    btn.Text = text
    btn.BackgroundColor3 = Color3.fromRGB(35,35,40)
    btn.TextColor3 = Color3.fromRGB(220,220,220)
    btn.Font = Enum.Font.SourceSansSemibold
    btn.TextSize = 14
    btn.AutoButtonColor = false
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0,5)
    -- 悬停效果
    btn.MouseEnter:Connect(function() btn.BackgroundColor3 = Color3.fromRGB(50,50,55) end)
    btn.MouseLeave:Connect(function() btn.BackgroundColor3 = Color3.fromRGB(35,35,40) end)
    return btn
end

local comboButton = createFuncBtn(mainFrame, UDim2.new(0,5,0,30), "杀戮光环")
local cycleTeleportButton = createFuncBtn(mainFrame, UDim2.new(0,5,0,75), "轮流传送")
local autoPipeButton = createFuncBtn(mainFrame, UDim2.new(0,5,0,120), "自动管道")

-- 状态变量
local isComboActive = false
local isMinimized = false
local isZoomed = false
local originalSize = mainFrame.Size
local minimizedSize = UDim2.new(0,80,0,40)
local zoomedSize = UDim2.new(0,140,0,165)
local maxDistance = 200
local teleportHeight = 0
local lastAttackTime = 0
local attackRate = 4
local cycleTeleportIndex = 1

-- 管道坐标（Vector3 原生格式，无解析成本）
local allPipeLocations = {
    Vector3.new(43.06, 68.98, -254.75),
    Vector3.new(-0.53, 71.14, -329.87),
    Vector3.new(12.90, 94.29, -531.77),
    Vector3.new(-13.55, 87.70, -455.12),
    Vector3.new(-38.72, 87.45, -269.56),
    Vector3.new(-60.21, 105.48, -156.82),
    Vector3.new(-44.85, 112.19, -398.75),
    Vector3.new(73.64, 105.44, -404.03),
    Vector3.new(327.87, 37.94, 246.22),
    Vector3.new(386.97, 7.47, 331.48),
    Vector3.new(408.68, 34.45, 169.92),
    Vector3.new(335.75, 18.12, 205.47),
    Vector3.new(406.35, 33.01, 375.60),
    Vector3.new(359.39, 18.07, 437.61),
    Vector3.new(184.68, 18.11, 245.28),
    Vector3.new(312.79, 10.66, 351.58),
    Vector3.new(358.95, 18, 436.84),
    Vector3.new(358.95, 18, 436.84)
}

-- 核心修复：自动管道函数（前置检测 + 无延迟执行）
local function performAutoPipeTeleport()
    -- 1. 前置检测角色和根部件，失败直接提示，不阻塞
    local character = player.Character
    if not character then
        createNotification("角色未加载", Color3.fromRGB(200,50,50))
        return
    end
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then
        createNotification("根部件不存在", Color3.fromRGB(200,50,50))
        return
    end

    -- 2. 立即更新按钮文本，无延迟
    autoPipeButton.Text = "传送中..."
    createNotification("开始自动管道传送", Color3.fromRGB(50,200,50))

    -- 3. 临时关闭杀戮光环
    local wasComboActive = isComboActive
    isComboActive = false
    comboButton.Text = "杀戮光环 [关]"

    -- 4. 记录原点
    local originalCFrame = rootPart.CFrame

    -- 5. 高速遍历传送：使用 Heartbeat 确保每步都被引擎识别，无等待
    task.spawn(function()
        for i, pos in ipairs(allPipeLocations) do
            rootPart.CFrame = CFrame.new(pos)
            autoPipeButton.Text = string.format("进度: %d/18", i)
            RunService.Heartbeat:Wait() -- 最小延迟，确保移动生效
        end
        -- 传送回原点
        rootPart.CFrame = originalCFrame
        -- 恢复状态
        if wasComboActive then
            isComboActive = true
            comboButton.Text = "杀戮光环 [开]"
        end
        autoPipeButton.Text = "自动管道"
        createNotification("自动管道传送完成", Color3.fromRGB(50,200,50))
    end)
end

-- 杀戮光环函数（保持防抖）
local function getNearestPlayer()
    local character = player.Character
    if not character then return nil end
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return nil end

    local nearestPlayer, nearestDist = nil, math.huge
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= player and p.Character then
            local targetRoot = p.Character:FindFirstChild("HumanoidRootPart")
            local humanoid = p.Character:FindFirstChild("Humanoid")
            if targetRoot and humanoid and humanoid.Health > 5 then
                local dist = (rootPart.Position - targetRoot.Position).Magnitude
                if dist < maxDistance and dist < nearestDist then
                    nearestDist = dist
                    nearestPlayer = p
                end
            end
        end
    end
    return nearestPlayer
end

local function performKillaura()
    if not isComboActive then
        comboNotifyFlag = false
        return
    end
    local nearest = getNearestPlayer()
    if not nearest then
        comboNotifyFlag = false
        comboButton.Text = "杀戮光环 [开]"
        return
    end

    local character = player.Character
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    local targetRoot = nearest.Character:FindFirstChild("HumanoidRootPart")
    if not rootPart or not targetRoot then return end

    -- 传送+自瞄
    rootPart.CFrame = CFrame.new(targetRoot.Position.X, targetRoot.Position.Y + teleportHeight, targetRoot.Position.Z)
    camera.CFrame = CFrame.lookAt(camera.CFrame.Position, targetRoot.Position)

    -- 攻击
    local currentTime = tick()
    if currentTime - lastAttackTime >= 1/attackRate then
        VirtualInputManager:SendMouseButtonEvent(0,0,0,true,game,0)
        task.wait(0.05)
        VirtualInputManager:SendMouseButtonEvent(0,0,0,false,game,0)
        lastAttackTime = currentTime
        if not comboNotifyFlag then
            createNotification("已锁定: "..nearest.Name, Color3.fromRGB(50,200,50))
            comboNotifyFlag = true
        end
    end
    comboButton.Text = "锁定: "..string.sub(nearest.Name,1,6)
end

-- 轮流传送函数
local function performCycleTeleport()
    local character = player.Character
    if not character then return end
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end

    local validPlayers = {}
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            table.insert(validPlayers, p)
        end
    end
    if #validPlayers == 0 then
        createNotification("无有效玩家", Color3.fromRGB(200,50,50))
        return
    end
    cycleTeleportIndex = cycleTeleportIndex % #validPlayers + 1
    local target = validPlayers[cycleTeleportIndex]
    local targetRoot = target.Character:FindFirstChild("HumanoidRootPart")
    rootPart.CFrame = CFrame.new(targetRoot.Position.X, targetRoot.Position.Y + teleportHeight, targetRoot.Position.Z)
    createNotification("传送到: "..target.Name, Color3.fromRGB(50,200,50))
end

-- 按钮事件绑定
zoomBtn.MouseButton1Click:Connect(function()
    isZoomed = not isZoomed
    mainFrame:TweenSize(isZoomed and zoomedSize or originalSize, Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.3, true)
    zoomBtn.Text = isZoomed and "⏺" or "⏺️"
end)

minimizeBtn.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    comboButton.Visible = not isMinimized
    cycleTeleportButton.Visible = not isMinimized
    autoPipeButton.Visible = not isMinimized
    mainFrame:TweenSize(isMinimized and minimizedSize or (isZoomed and zoomedSize or originalSize), Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.3, true)
    minimizeBtn.Text = isMinimized and "+" or "_"
end)

closeBtn.MouseButton1Click:Connect(function()
    TweenService:Create(mainFrame, TweenInfo.new(0.3), {BackgroundTransparency = 0.8, Position = mainFrame.Position + UDim2.new(0,0,0,-20)}):Play()
    task.wait(0.3)
    screenGui:Destroy()
    isRunning = false
end)

comboButton.MouseButton1Click:Connect(function()
    isComboActive = not isComboActive
    comboButton.Text = isComboActive and "杀戮光环 [开]" or "杀戮光环 [关]"
    createNotification(isComboActive and "杀戮光环已开启" or "杀戮光环已关闭", isComboActive and Color3.fromRGB(50,200,50) or Color3.fromRGB(200,50,50))
end)

cycleTeleportButton.MouseButton1Click:Connect(performCycleTeleport)
autoPipeButton.MouseButton1Click:Connect(performAutoPipeTeleport)

-- 快捷键
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode.RightControl then
        isComboActive = not isComboActive
        comboButton.Text = isComboActive and "杀戮光环 [开]" or "杀戮光环 [关]"
        createNotification(isComboActive and "杀戮光环已开启" or "杀戮光环已关闭", isComboActive and Color3.fromRGB(50,200,50) or Color3.fromRGB(200,50,50))
    end
end)

-- 主循环
RunService.Heartbeat:Connect(function()
    if isRunning then performKillaura() end
end)

-- 初始淡入
mainFrame.BackgroundTransparency = 1
mainFrame.Position = UDim2.new(0.02,0,0.3,-30)
TweenService:Create(mainFrame, TweenInfo.new(0.5), {
    BackgroundTransparency = 0.1,
    Position = UDim2.new(0.02,0,0.3,0)
}):Play()
createNotification("Killaura面板已加载", Color3.fromRGB(50,200,50))