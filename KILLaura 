-- killaura
local SoundService = game:GetService("SoundService")

-- 创建音频实例
local sound = Instance.new("Sound")
sound.SoundId = "rbxassetid://7390036132"  -- 替换为你的音频ID
sound.Parent = SoundService

-- 播放音频
sound:Play()
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local isRunning = true
-- 强制等待游戏核心服务加载
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local SoundService = game:GetService("SoundService")

-- 关键：强制等待玩家和PlayerGui加载完成，超时10秒
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui", 10)
if not playerGui then
    warn("[ERROR] PlayerGui加载超时")
    return
end

-- 关键：等待角色加载完成，确保根部件存在
local character = player.Character or player.CharacterAdded:Wait()
local rootPart = character:WaitForChild("HumanoidRootPart", 10) or character:WaitForChild("Torso", 10)
if not rootPart then
    warn("[ERROR] 角色根部件加载失败")
    return
end

local isRunning = true
local camera = Workspace.CurrentCamera
local comboNotifyFlag = false

-- ========== 弹窗提示函数 ==========
local function createNotification(text, color)
    local existingNotify = playerGui:FindFirstChild("KillauraNotify")
    if existingNotify then existingNotify:Destroy() end
    local notifyGui = Instance.new("ScreenGui")
    notifyGui.Name = "KillauraNotify"
    notifyGui.IgnoreGuiInset = true
    notifyGui.Parent = playerGui
    -- 强制置顶，确保显示
    notifyGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    local notifyFrame = Instance.new("Frame")
    notifyFrame.Size = UDim2.new(0,220,0,60)
    notifyFrame.Position = UDim2.new(1,-230,1,-90)
    notifyFrame.BackgroundColor3 = Color3.fromRGB(25,25,30)
    notifyFrame.BackgroundTransparency = 0.1
    notifyFrame.Parent = notifyGui
    notifyFrame.ZIndex = 100
    Instance.new("UICorner", notifyFrame).CornerRadius = UDim.new(0,8)
    Instance.new("UIStroke", notifyFrame).Color = color or Color3.fromRGB(60,60,70)

    local notifyLabel = Instance.new("TextLabel")
    notifyLabel.Size = UDim2.new(1,-10,1,-10)
    notifyLabel.Position = UDim2.new(0,5,0,5)
    notifyLabel.BackgroundTransparency = 1
    notifyLabel.Text = text
    notifyLabel.TextColor3 = Color3.fromRGB(240,240,240)
    notifyLabel.TextSize = 14
    notifyLabel.TextWrapped = true
    notifyLabel.Font = Enum.Font.SourceSansSemibold
    notifyLabel.Parent = notifyFrame
    notifyLabel.ZIndex = 101

    TweenService:Create(notifyFrame, TweenInfo.new(0.1), {
        BackgroundTransparency = 0.1,
        Position = UDim2.new(1,-230,1,-90)
    }):Play()

    task.delay(3, function()
        TweenService:Create(notifyFrame, TweenInfo.new(0.3), {
            BackgroundTransparency = 1,
            Position = UDim2.new(1,-200,1,-90)
        }):Play()
        task.wait(0.3)
        notifyGui:Destroy()
    end)
end

-- ========== 强制创建UI，确保渲染 ==========
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "MonsterKillauraGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui
-- 强制置顶UI，防止被其他界面遮挡
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- 主面板
local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 120, 0, 215)
mainFrame.Position = UDim2.new(0.02, 0, 0.3, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
mainFrame.BackgroundTransparency = 0.1
mainFrame.BorderSizePixel = 1
mainFrame.BorderColor3 = Color3.fromRGB(60, 60, 70)
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.ClipsDescendants = true
mainFrame.Parent = screenGui
mainFrame.ZIndex = 10
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 6)

-- 标题栏
local titleBar = Instance.new("Frame")
titleBar.Name = "TitleBar"
titleBar.Size = UDim2.new(1, 0, 0, 25)
titleBar.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame
titleBar.ZIndex = 11
Instance.new("UICorner", titleBar).CornerRadius = UDim.new(0, 6)

-- 鸭子logo 【核心修改：调整ZIndex为3，低于按钮层级】
local titleImage = Instance.new("ImageLabel")
titleImage.Name = "TitleDuckImage"
titleImage.Size = UDim2.new(0, 20, 0, 20)
titleImage.Position = UDim2.new(0, 5, 0, 2)
titleImage.BackgroundTransparency = 1
titleImage.Image = "rbxassetid://98446998103932"
titleImage.ScaleType = Enum.ScaleType.Fit
titleImage.Parent = titleBar
titleImage.ZIndex = 3 -- 原12 → 改为3，低于按钮的12

-- 标题文字
local titleText = Instance.new("TextLabel")
titleText.Text = " Monster"
titleText.Size = UDim2.new(1, -30, 1, 0)
titleText.Position = UDim2.new(0, 25, 0, 0)
titleText.BackgroundTransparency = 1
titleText.TextColor3 = Color3.fromRGB(220, 220, 220)
titleText.TextXAlignment = Enum.TextXAlignment.Left
titleText.Font = Enum.Font.SourceSansSemibold
titleText.TextSize = 14
titleText.Parent = titleBar
titleText.ZIndex = 12

-- 控制按钮容器
local controlButtons = Instance.new("Frame")
controlButtons.Size = UDim2.new(0, 75, 1, 0)
controlButtons.Position = UDim2.new(1, -75, 0, 0)
controlButtons.BackgroundTransparency = 1
controlButtons.Parent = titleBar
controlButtons.ZIndex = 11

-- 控制按钮创建函数
local function createCtrlBtn(parent, pos, text, color)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0,25,0,25)
    btn.Position = pos
    btn.Text = text
    btn.BackgroundColor3 = color
    btn.TextColor3 = Color3.fromRGB(220,220,220)
    btn.Font = Enum.Font.SourceSansBold
    btn.TextSize = 14
    btn.AutoButtonColor = false
    btn.Parent = parent
    btn.ZIndex = 12
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0,4)
    local origColor = btn.BackgroundColor3
    btn.MouseEnter:Connect(function() btn.BackgroundColor3 = Color3.fromRGB(origColor.R*255+15, origColor.G*255+15, origColor.B*255+15)/255 end)
    btn.MouseLeave:Connect(function() btn.BackgroundColor3 = origColor end)
    return btn
end

local zoomBtn = createCtrlBtn(controlButtons, UDim2.new(0,0,0,0), "⏺️", Color3.fromRGB(40,40,45))
local minimizeBtn = createCtrlBtn(controlButtons, UDim2.new(0,25,0,0), "_", Color3.fromRGB(40,40,45))
local closeBtn = createCtrlBtn(controlButtons, UDim2.new(0,50,0,0), "×", Color3.fromRGB(45,35,35))

-- 功能按钮创建函数
local function createFuncBtn(parent, pos, text)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1,-10,0,40)
    btn.Position = pos
    btn.Text = text
    btn.BackgroundColor3 = Color3.fromRGB(35,35,40)
    btn.TextColor3 = Color3.fromRGB(220,220,220)
    btn.Font = Enum.Font.SourceSansSemibold
    btn.TextSize = 14
    btn.AutoButtonColor = false
    btn.Parent = parent
    btn.ZIndex = 12
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0,5)
    local origColor = btn.BackgroundColor3
    btn.MouseEnter:Connect(function() btn.BackgroundColor3 = Color3.fromRGB(50,50,55) end)
    btn.MouseLeave:Connect(function() btn.BackgroundColor3 = origColor end)
    return btn
end

local comboButton = createFuncBtn(mainFrame, UDim2.new(0,5,0,30), "杀戮光环 [关]")
local cycleTeleportButton = createFuncBtn(mainFrame, UDim2.new(0,5,0,75), "轮流传送")
local autoPipeButton = createFuncBtn(mainFrame, UDim2.new(0,5,0,120), "致命管道")

-- 缩小状态提示标签
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1,-10,1,-10)
statusLabel.Position = UDim2.new(0,5,0,5)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "Monster\n点击展开"
statusLabel.TextColor3 = Color3.fromRGB(180,180,180)
statusLabel.TextSize = 12
statusLabel.TextWrapped = true
statusLabel.Visible = false
statusLabel.Parent = mainFrame
statusLabel.ZIndex = 12

-- ========== 状态变量 ==========
local isComboActive = false
local isMinimized = false
local isZoomed = false
local originalSize = mainFrame.Size
local minimizedSize = UDim2.new(0,80,0,40)
local zoomedSize = UDim2.new(0,140,0,225)
local maxDistance = 200
local teleportHeight = 0
local lastAttackTime = 0
local attackRate = 4
local cycleTeleportIndex = 1

-- 管道坐标
local allPipeLocations = {
    Vector3.new(43.06, 68.98, -254.75),
    Vector3.new(-0.53, 71.14, -329.87),
    Vector3.new(12.90, 94.29, -531.77),
    Vector3.new(-13.55, 87.70, -455.12),
    Vector3.new(-38.72, 87.45, -269.56),
    Vector3.new(-60.21, 105.48, -156.82),
    Vector3.new(-44.85, 112.19, -398.75),
    Vector3.new(73.64, 105.44, -404.03),
    Vector3.new(327.87, 37.94, 246.22),
    Vector3.new(386.97, 7.47, 331.48),
    Vector3.new(408.68, 34.45, 169.92),
    Vector3.new(335.75, 18.12, 205.47),
    Vector3.new(406.35, 33.01, 375.60),
    Vector3.new(359.39, 18.07, 437.61),
    Vector3.new(184.68, 18.11, 245.28),
    Vector3.new(312.79, 10.66, 351.58),
    Vector3.new(358.95, 18, 436.84),
    Vector3.new(358.95, 18, 436.84)
}

-- ========== 核心：致命管道 原逻辑保留 ==========
local function performAutoPipeTeleport()
    -- 实时刷新根部件，防止角色重置失效
    rootPart = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso")
    if not rootPart then
        createNotification("根部件丢失", Color3.fromRGB(200,50,50))
        return
    end

    -- 点击后 0延迟 更新状态
    autoPipeButton.Text = "传送中..."
    createNotification("开始致命管道传送", Color3.fromRGB(50,200,50))
    local originalCFrame = rootPart.CFrame

    -- 原生分步传送，帧间隔执行，可感知过程
    task.spawn(function()
        for i, pos in ipairs(allPipeLocations) do
            rootPart.CFrame = CFrame.new(pos)
            autoPipeButton.Text = string.format("进度: %d/18", i)
            RunService.Heartbeat:Wait()
        end
        rootPart.CFrame = originalCFrame
        autoPipeButton.Text = "致命管道"
        createNotification("致命管道传送完成", Color3.fromRGB(50,200,50))
        if isMinimized then statusLabel.Text = "✅ 管道传送完成" end
    end)
end

-- ========== 杀戮光环函数 ==========
local function getNearestPlayer()
    rootPart = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso")
    if not character or not rootPart then return nil end

    local nearestPlayer, nearestDist = nil, math.huge
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= player and p.Character then
            local targetRoot = p.Character:FindFirstChild("HumanoidRootPart")
            local humanoid = p.Character:FindFirstChild("Humanoid")
            if targetRoot and humanoid and humanoid.Health > 5 then
                local dist = (rootPart.Position - targetRoot.Position).Magnitude
                if dist < maxDistance and dist < nearestDist then
                    nearestDist = dist
                    nearestPlayer = p
                end
            end
        end
    end
    return nearestPlayer
end

local function performKillaura()
    if not isComboActive then
        comboNotifyFlag = false
        return
    end
    local nearest = getNearestPlayer()
    if not nearest then
        comboNotifyFlag = false
        comboButton.Text = "杀戮光环 [开]"
        if isMinimized then statusLabel.Text = " Monster\n未锁定目标" end
        return
    end

    rootPart = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso")
    local targetRoot = nearest.Character:FindFirstChild("HumanoidRootPart")
    if not rootPart or not targetRoot then return end

    rootPart.CFrame = CFrame.new(targetRoot.Position.X, targetRoot.Position.Y + teleportHeight, targetRoot.Position.Z)
    camera.CFrame = CFrame.lookAt(camera.CFrame.Position, targetRoot.Position)

    local currentTime = tick()
    if currentTime - lastAttackTime >= 1/attackRate then
        VirtualInputManager:SendMouseButtonEvent(0,0,0,true,game,0)
        task.wait(0.05)
        VirtualInputManager:SendMouseButtonEvent(0,0,0,false,game,0)
        lastAttackTime = currentTime
        if not comboNotifyFlag then
            createNotification("已锁定: "..nearest.Name, Color3.fromRGB(50,200,50))
            comboNotifyFlag = true
            if isMinimized then statusLabel.Text = " 锁定: "..string.sub(nearest.Name,1,6) end
        end
    end
    comboButton.Text = "锁定: "..string.sub(nearest.Name,1,6)
end

-- ========== 轮流传送函数 ==========
local function performCycleTeleport()
    rootPart = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso")
    if not character or not rootPart then return end

    local validPlayers = {}
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            table.insert(validPlayers, p)
        end
    end
    if #validPlayers == 0 then
        createNotification("无有效玩家", Color3.fromRGB(200,50,50))
        return
    end
    cycleTeleportIndex = cycleTeleportIndex % #validPlayers + 1
    local target = validPlayers[cycleTeleportIndex]
    local targetRoot = target.Character:FindFirstChild("HumanoidRootPart")
    rootPart.CFrame = CFrame.new(targetRoot.Position.X, targetRoot.Position.Y + teleportHeight, targetRoot.Position.Z)
    createNotification("传送到: "..target.Name, Color3.fromRGB(50,200,50))
    if isMinimized then statusLabel.Text = "➡ 传送到: "..string.sub(target.Name,1,6) end
end

-- ========== UI交互逻辑 ==========
zoomBtn.MouseButton1Click:Connect(function()
    isZoomed = not isZoomed
    local targetSize = isZoomed and zoomedSize or originalSize
    TweenService:Create(mainFrame, TweenInfo.new(0.3), {Size = targetSize}):Play()
    zoomBtn.Text = isZoomed and "⏺" or "⏺️"
end)

minimizeBtn.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    if isMinimized then
        TweenService:Create(mainFrame, TweenInfo.new(0.3), {Size = minimizedSize}):Play()
        comboButton.Visible = false
        cycleTeleportButton.Visible = false
        autoPipeButton.Visible = false
        statusLabel.Visible = true
        minimizeBtn.Text = "+"
        titleText.Visible = false
        titleImage.Size = UDim2.new(0, 20, 0, 20)
        titleImage.Position = UDim2.new(0.5, -10, 0, 2)
        if isComboActive then
            statusLabel.Text = " 杀戮光环开启"
        else
            statusLabel.Text = " Monster\n点击展开"
        end
    else
        comboButton.Visible = true
        cycleTeleportButton.Visible = true
        autoPipeButton.Visible = true
        statusLabel.Visible = false
        minimizeBtn.Text = "_"
        titleText.Visible = true
        titleImage.Size = UDim2.new(0, 20, 0, 20)
        titleImage.Position = UDim2.new(0, 5, 0, 2)
        local targetSize = isZoomed and zoomedSize or originalSize
        TweenService:Create(mainFrame, TweenInfo.new(0.3), {Size = targetSize}):Play()
    end
end)

closeBtn.MouseButton1Click:Connect(function()
    TweenService:Create(mainFrame, TweenInfo.new(0.3), {
        BackgroundTransparency = 0.8,
        Position = mainFrame.Position + UDim2.new(0,0,0,-20)
    }):Play()
    task.wait(0.3)
    screenGui:Destroy()
    isRunning = false
    createNotification("Killaura面板已关闭", Color3.fromRGB(200,50,50))
end)

comboButton.MouseButton1Click:Connect(function()
    isComboActive = not isComboActive
    comboButton.Text = isComboActive and "杀戮光环 [开]" or "杀戮光环 [关]"
    mainFrame.Draggable = not isComboActive
    createNotification(isComboActive and "杀戮光环已开启(UI固定)" or "杀戮光环已关闭(UI可拖动)", isComboActive and Color3.fromRGB(50,200,50) or Color3.fromRGB(200,50,50))
    if isMinimized then statusLabel.Text = isComboActive and " 杀戮光环开启" or " Monster\n点击展开" end
end)

-- 绑定点击事件，0延迟触发
cycleTeleportButton.MouseButton1Click:Connect(performCycleTeleport)
autoPipeButton.MouseButton1Click:Connect(performAutoPipeTeleport)

-- 快捷键
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode.RightControl then
        isComboActive = not isComboActive
        comboButton.Text = isComboActive and "杀戮光环 [开]" or "杀戮光环 [关]"
        mainFrame.Draggable = not isComboActive
        createNotification(isComboActive and "杀戮光环已开启(UI固定)" or "杀戮光环已关闭(UI可拖动)", isComboActive and Color3.fromRGB(50,200,50) or Color3.fromRGB(200,50,50))
        if isMinimized then statusLabel.Text = isComboActive and " 杀戮光环开启" or " Monster\n点击展开" end
    end
end)

-- 主循环
RunService.Heartbeat:Connect(function()
    if isRunning then performKillaura() end
end)

-- 强制触发UI显示动画
mainFrame.BackgroundTransparency = 1
mainFrame.Position = UDim2.new(0.02,0,0.3,-30)
TweenService:Create(mainFrame, TweenInfo.new(0.2), {
    BackgroundTransparency = 0.1,
    Position = UDim2.new(0.02,0,0.3,0)
}):Play()
createNotification(" Monster Killaura面板已加载", Color3.fromRGB(50,200,50))

-- 音频初始化（最后加载，避免阻塞UI）
local sound = Instance.new("Sound")
sound.SoundId = "rbxassetid://98446998103932"
sound.Parent = SoundService
sound:Play()