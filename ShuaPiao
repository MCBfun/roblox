-- 多功能互动管理器 (指定autoInteract循环逻辑)
local PlayerGui = game:GetService("Players").LocalPlayer:WaitForChild("PlayerGui")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- 创建主界面
local AutoInteractUI = Instance.new("ScreenGui")
AutoInteractUI.Name = "AutoInteractUI"
AutoInteractUI.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- 主窗口
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 220, 0, 180)
MainFrame.Position = UDim2.new(0.5, -110, 0, 50)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = AutoInteractUI

-- 圆角
local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = MainFrame

-- 标题栏
local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 25)
TitleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MainFrame

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 8)
TitleCorner.Parent = TitleBar

local TitleText = Instance.new("TextLabel")
TitleText.Name = "TitleText"
TitleText.Size = UDim2.new(1, -50, 1, 0)
TitleText.Position = UDim2.new(0, 5, 0, 0)
TitleText.BackgroundTransparency = 1
TitleText.Text = "多功能管理器"
TitleText.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleText.TextSize = 12
TitleText.Font = Enum.Font.GothamMedium
TitleText.TextXAlignment = Enum.TextXAlignment.Left
TitleText.Parent = TitleBar

-- 关闭按钮
local CloseButton = Instance.new("TextButton")
CloseButton.Name = "CloseButton"
CloseButton.Size = UDim2.new(0, 25, 0, 25)
CloseButton.Position = UDim2.new(1, -25, 0, 0)
CloseButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
CloseButton.Text = "×"
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.TextSize = 16
CloseButton.Font = Enum.Font.GothamBold
CloseButton.Parent = TitleBar

local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(0, 8)
CloseCorner.Parent = CloseButton

-- 最小化按钮
local MinimizeButton = Instance.new("TextButton")
MinimizeButton.Name = "MinimizeButton"
MinimizeButton.Size = UDim2.new(0, 25, 0, 25)
MinimizeButton.Position = UDim2.new(1, -50, 0, 0)
MinimizeButton.BackgroundColor3 = Color3.fromRGB(60, 120, 200)
MinimizeButton.Text = "—"
MinimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
MinimizeButton.TextSize = 16
MinimizeButton.Font = Enum.Font.GothamBold
MinimizeButton.Parent = TitleBar

local MinimizeCorner = Instance.new("UICorner")
MinimizeCorner.CornerRadius = UDim.new(0, 8)
MinimizeCorner.Parent = MinimizeButton

-- 内容区域
local ContentFrame = Instance.new("Frame")
ContentFrame.Name = "ContentFrame"
ContentFrame.Size = UDim2.new(1, -10, 1, -35)
ContentFrame.Position = UDim2.new(0, 5, 0, 30)
ContentFrame.BackgroundTransparency = 1
ContentFrame.Parent = MainFrame

-- 作为逃生自动化自救开关
local InteractToggle = Instance.new("TextButton")
InteractToggle.Name = "InteractToggle"
InteractToggle.Size = UDim2.new(1, 0, 0, 35)
InteractToggle.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
InteractToggle.Text = "作为逃生自动化自救：关闭"
InteractToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
InteractToggle.TextSize = 14
InteractToggle.Font = Enum.Font.GothamMedium
InteractToggle.Parent = ContentFrame

local ToggleCorner = Instance.new("UICorner")
ToggleCorner.CornerRadius = UDim.new(0, 6)
ToggleCorner.Parent = InteractToggle

-- 自瞄开关
local AimToggle = Instance.new("TextButton")
AimToggle.Name = "AimToggle"
AimToggle.Size = UDim2.new(1, 0, 0, 35)
AimToggle.Position = UDim2.new(0, 0, 0, 40)
AimToggle.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
AimToggle.Text = "作为怪物自动化攻击：关闭"
AimToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
AimToggle.TextSize = 14
AimToggle.Font = Enum.Font.GothamMedium
AimToggle.Parent = ContentFrame

local AimCorner = Instance.new("UICorner")
AimCorner.CornerRadius = UDim.new(0, 6)
AimCorner.Parent = AimToggle

-- 自救频率调节区域【加减按钮】
local FrequencyLabel = Instance.new("TextLabel")
FrequencyLabel.Name = "FrequencyLabel"
FrequencyLabel.Size = UDim2.new(1, 0, 0, 20)
FrequencyLabel.Position = UDim2.new(0, 0, 0, 80)
FrequencyLabel.BackgroundTransparency = 1
FrequencyLabel.Text = "自救频率: 0.25秒"
FrequencyLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
FrequencyLabel.TextSize = 12
FrequencyLabel.Font = Enum.Font.Gotham
FrequencyLabel.TextXAlignment = Enum.TextXAlignment.Center
FrequencyLabel.Parent = ContentFrame

-- 自救频率调节按钮容器
local FrequencyBtnFrame = Instance.new("Frame")
FrequencyBtnFrame.Name = "FrequencyBtnFrame"
FrequencyBtnFrame.Size = UDim2.new(1, 0, 0, 18)
FrequencyBtnFrame.Position = UDim2.new(0, 0, 0, 100)
FrequencyBtnFrame.BackgroundTransparency = 1
FrequencyBtnFrame.Parent = ContentFrame

-- 减号按钮 (-0.05秒)
local MinusBtn = Instance.new("TextButton")
MinusBtn.Name = "MinusBtn"
MinusBtn.Size = UDim2.new(0.3, 0, 1, 0)
MinusBtn.Position = UDim2.new(0, 0, 0, 0)
MinusBtn.BackgroundColor3 = Color3.fromRGB(60, 90, 180)
MinusBtn.Text = "-"
MinusBtn.TextColor3 = Color3.fromRGB(255,255,255)
MinusBtn.TextSize = 14
MinusBtn.Font = Enum.Font.GothamBold
MinusBtn.Parent = FrequencyBtnFrame
local MinusCorner = Instance.new("UICorner")
MinusCorner.CornerRadius = UDim.new(0,4)
MinusCorner.Parent = MinusBtn

-- 重置按钮
local ResetBtn = Instance.new("TextButton")
ResetBtn.Name = "ResetBtn"
ResetBtn.Size = UDim2.new(0.38, 0, 1, 0)
ResetBtn.Position = UDim2.new(0.31, 0, 0, 0)
ResetBtn.BackgroundColor3 = Color3.fromRGB(50,50,55)
ResetBtn.Text = "重置"
ResetBtn.TextColor3 = Color3.fromRGB(200,200,200)
ResetBtn.TextSize = 10
ResetBtn.Font = Enum.Font.Gotham
ResetBtn.Parent = FrequencyBtnFrame
local ResetCorner = Instance.new("UICorner")
ResetCorner.CornerRadius = UDim.new(0,4)
ResetCorner.Parent = ResetBtn

-- 加号按钮 (+0.1秒)
local PlusBtn = Instance.new("TextButton")
PlusBtn.Name = "PlusBtn"
PlusBtn.Size = UDim2.new(0.3, 0, 1, 0)
PlusBtn.Position = UDim2.new(0.7, 0, 0, 0)
PlusBtn.BackgroundColor3 = Color3.fromRGB(180, 90, 60)
PlusBtn.Text = "+"
PlusBtn.TextColor3 = Color3.fromRGB(255,255,255)
PlusBtn.TextSize = 14
PlusBtn.Font = Enum.Font.GothamBold
PlusBtn.Parent = FrequencyBtnFrame
local PlusCorner = Instance.new("UICorner")
PlusCorner.CornerRadius = UDim.new(0,4)
PlusCorner.Parent = PlusBtn

-- 将UI添加到屏幕
AutoInteractUI.Parent = PlayerGui

-- 变量
local autoInteract = false
local isAimEnabled = false
local currentFrequency = 0.25
local minFrequency = 0.05
local maxFrequency = 3.0
local isMinimized = false
local isDragging = false
local dragStartPos
local frameStartPos
local aimConnection
local autoInteractThread -- 存储作为逃生自动化自救线程，用于关闭

-- 启用快速互动
local function enableFastInteract()
    for _, descendant in pairs(workspace:GetDescendants()) do
        if descendant:IsA("ProximityPrompt") then
            descendant.HoldDuration = 0
        end
    end
    game:GetService("ProximityPromptService").PromptShown:Connect(function(prompt)
        if prompt:IsA("ProximityPrompt") then
            prompt.HoldDuration = 0
        end
    end)
end

-- 更新按钮状态
local function updateUIState()
    if autoInteract then
        InteractToggle.Text = "作为逃生自动化自救：开启"
        InteractToggle.BackgroundColor3 = Color3.fromRGB(60, 200, 80)
    else
        InteractToggle.Text = "作为逃生自动化自救：关闭"
        InteractToggle.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
    end
    if isAimEnabled then
        AimToggle.Text = "作为怪物自动化攻击：开启"
        AimToggle.BackgroundColor3 = Color3.fromRGB(60, 200, 80)
    else
        AimToggle.Text = "作为怪物自动化攻击：关闭"
        AimToggle.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
    end
    FrequencyLabel.Text = "自救频率: " .. string.format("%.2f", currentFrequency) .. "秒"
end

-- 获取最近的玩家
local function getNearestPlayer()
    local localPlayer = game:GetService("Players").LocalPlayer
    local localPos = localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not localPos then return nil end
    local nearestPlayer = nil
    local nearestDistance = math.huge
    for _, player in pairs(game:GetService("Players"):GetPlayers()) do
        if player ~= localPlayer and player.Character then
            local targetPos = player.Character:FindFirstChild("HumanoidRootPart")
            if targetPos then
                local distance = (targetPos.Position - localPos.Position).Magnitude
                if distance < nearestDistance then
                    nearestDistance = distance
                    nearestPlayer = player
                end
            end
        end
    end
    return nearestPlayer, nearestDistance
end

-- 执行右键自瞄
local function performRightClickAim()
    local nearestPlayer, distance = getNearestPlayer()
    if nearestPlayer and distance < 50 then
        local camera = workspace.CurrentCamera
        local targetPos = nearestPlayer.Character:FindFirstChild("HumanoidRootPart").Position
        camera.CFrame = CFrame.new(camera.CFrame.Position, targetPos)
        pcall(function()
            game:GetService("VirtualInputManager"):SendMouseButtonEvent(0, 0, 0, true, game, 1)
            task.wait(0.05)
            game:GetService("VirtualInputManager"):SendMouseButtonEvent(0, 0, 0, false, game, 1)
        end)
    end
end

-- 切换作为逃生自动化自救【核心替换为指定循环】
local function toggleAutoInteract()
    autoInteract = not autoInteract
    if autoInteract then
        -- 启用：运行指定的循环逻辑，放入独立线程不阻塞UI
        autoInteractThread = task.spawn(function()
            while autoInteract do
                for _, descendant in pairs(workspace:GetDescendants()) do
                    if descendant:IsA("ProximityPrompt") then
                        fireproximityprompt(descendant)
                    end
                end
                task.wait(currentFrequency) -- 适配调节的自救频率，而非固定0.25
            end
        end)
    else
        -- 关闭：终止线程
        if autoInteractThread then
            task.cancel(autoInteractThread)
            autoInteractThread = nil
        end
    end
    updateUIState()
end

-- 切换作为怪物自动化攻击
local function toggleAutoAim()
    isAimEnabled = not isAimEnabled
    if aimConnection then
        aimConnection:Disconnect()
        aimConnection = nil
    end
    if isAimEnabled then
        aimConnection = RunService.Heartbeat:Connect(function()
            if not isAimEnabled then return end
            performRightClickAim()
            task.wait(0.1)
        end)
    end
    updateUIState()
end

-- 自救频率调节逻辑
MinusBtn.MouseButton1Click:Connect(function()
    currentFrequency = math.max(minFrequency, currentFrequency - 0.05)
    updateUIState()
end)
PlusBtn.MouseButton1Click:Connect(function()
    currentFrequency = math.min(maxFrequency, currentFrequency + 0.1)
    updateUIState()
end)
ResetBtn.MouseButton1Click:Connect(function()
    currentFrequency = 0.25
    updateUIState()
end)

-- 初始化
enableFastInteract()
updateUIState()

-- 绑定按钮事件
InteractToggle.MouseButton1Click:Connect(toggleAutoInteract)
AimToggle.MouseButton1Click:Connect(toggleAutoAim)

-- 关闭按钮
CloseButton.MouseButton1Click:Connect(function()
    AutoInteractUI:Destroy()
    autoInteract = false -- 终止作为逃生自动化自救
    if autoInteractThread then task.cancel(autoInteractThread) end
    if aimConnection then aimConnection:Disconnect() end
end)

-- 最小化按钮
MinimizeButton.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    if isMinimized then
        ContentFrame.Visible = false
        MainFrame.Size = UDim2.new(0, 220, 0, 25)
        MinimizeButton.Text = "＋"
    else
        ContentFrame.Visible = true
        MainFrame.Size = UDim2.new(0, 220, 0, 180)
        MinimizeButton.Text = "—"
    end
end)

-- 窗口拖动功能
TitleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        isDragging = true
        dragStartPos = input.Position
        frameStartPos = MainFrame.Position
    end
end)
UIS.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement and isDragging then
        local delta = input.Position - dragStartPos
        MainFrame.Position = UDim2.new(frameStartPos.X.Scale, frameStartPos.X.Offset + delta.X, frameStartPos.Y.Scale, frameStartPos.Y.Offset + delta.Y)
    end
end)
UIS.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        isDragging = false
    end
end)

print("多功能管理器已加载 | 作为逃生自动化自救已替换为指定循环逻辑")