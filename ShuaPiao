-- 顶级刷票脚本 - 攻击功能修复版
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local ProximityPromptService = game:GetService("ProximityPromptService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- 创建主界面
local AutoInteractUI = Instance.new("ScreenGui")
AutoInteractUI.Name = "AutoInteractUI"
AutoInteractUI.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- 主窗口
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 220, 0, 240)
MainFrame.Position = UDim2.new(0.5, -10, 0, 50)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = AutoInteractUI

-- 圆角
local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 8)
UICorner.Parent = MainFrame

-- 标题栏
local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 25)
TitleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MainFrame

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 8)
TitleCorner.Parent = TitleBar

local TitleText = Instance.new("TextLabel")
TitleText.Name = "TitleText"
TitleText.Size = UDim2.new(1, -50, 1, 0)
TitleText.Position = UDim2.new(0, 5, 0, 0)
TitleText.BackgroundTransparency = 1
TitleText.Text = "顶级刷票脚本"
TitleText.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleText.TextSize = 12
TitleText.Font = Enum.Font.GothamMedium
TitleText.TextXAlignment = Enum.TextXAlignment.Left
TitleText.Parent = TitleBar

-- 关闭按钮
local CloseButton = Instance.new("TextButton")
CloseButton.Name = "CloseButton"
CloseButton.Size = UDim2.new(0, 25, 0, 25)
CloseButton.Position = UDim2.new(1, -25, 0, 0)
CloseButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
CloseButton.Text = "×"
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.TextSize = 16
CloseButton.Font = Enum.Font.GothamBold
CloseButton.Parent = TitleBar

local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(0, 8)
CloseCorner.Parent = CloseButton

-- 最小化按钮
local MinimizeButton = Instance.new("TextButton")
MinimizeButton.Name = "MinimizeButton"
MinimizeButton.Size = UDim2.new(0, 25, 0, 25)
MinimizeButton.Position = UDim2.new(1, -50, 0, 0)
MinimizeButton.BackgroundColor3 = Color3.fromRGB(60, 120, 200)
MinimizeButton.Text = "—"
MinimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
MinimizeButton.TextSize = 16
MinimizeButton.Font = Enum.Font.GothamBold
MinimizeButton.Parent = TitleBar

local MinimizeCorner = Instance.new("UICorner")
MinimizeCorner.CornerRadius = UDim.new(0, 8)
MinimizeCorner.Parent = MinimizeButton

-- 内容区域
local ContentFrame = Instance.new("Frame")
ContentFrame.Name = "ContentFrame"
ContentFrame.Size = UDim2.new(1, -10, 1, -35)
ContentFrame.Position = UDim2.new(0, 5, 0, 30)
ContentFrame.BackgroundTransparency = 1
ContentFrame.Parent = MainFrame

-- 自动互动开关
local InteractToggle = Instance.new("TextButton")
InteractToggle.Name = "InteractToggle"
InteractToggle.Size = UDim2.new(1, 0, 0, 35)
InteractToggle.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
InteractToggle.Text = "自动互动：关闭"
InteractToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
InteractToggle.TextSize = 14
InteractToggle.Font = Enum.Font.GothamMedium
InteractToggle.Parent = ContentFrame

local ToggleCorner = Instance.new("UICorner")
ToggleCorner.CornerRadius = UDim.new(0, 6)
ToggleCorner.Parent = InteractToggle

-- 自动攻击开关
local AttackToggle = Instance.new("TextButton")
AttackToggle.Name = "AttackToggle"
AttackToggle.Size = UDim2.new(1, 0, 0, 35)
AttackToggle.Position = UDim2.new(0, 0, 0, 40)
AttackToggle.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
AttackToggle.Text = "自动攻击：关闭"
AttackToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
AttackToggle.TextSize = 14
AttackToggle.Font = Enum.Font.GothamMedium
AttackToggle.Parent = ContentFrame

local AttackCorner = Instance.new("UICorner")
AttackCorner.CornerRadius = UDim.new(0, 6)
AttackCorner.Parent = AttackToggle

-- 互动频率区域
local InteractFreqLabel = Instance.new("TextLabel")
InteractFreqLabel.Name = "InteractFreqLabel"
InteractFreqLabel.Size = UDim2.new(1, 0, 0, 20)
InteractFreqLabel.Position = UDim2.new(0, 0, 0, 85)
InteractFreqLabel.BackgroundTransparency = 1
InteractFreqLabel.Text = "互动频率: 0.25秒"
InteractFreqLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
InteractFreqLabel.TextSize = 12
InteractFreqLabel.Font = Enum.Font.Gotham
InteractFreqLabel.TextXAlignment = Enum.TextXAlignment.Center
InteractFreqLabel.Parent = ContentFrame

-- 互动频率按钮容器
local InteractFreqFrame = Instance.new("Frame")
InteractFreqFrame.Name = "InteractFreqFrame"
InteractFreqFrame.Size = UDim2.new(1, 0, 0, 18)
InteractFreqFrame.Position = UDim2.new(0, 0, 0, 105)
InteractFreqFrame.BackgroundTransparency = 1
InteractFreqFrame.Parent = ContentFrame

-- 减号按钮
local MinusBtn = Instance.new("TextButton")
MinusBtn.Name = "MinusBtn"
MinusBtn.Size = UDim2.new(0.3, 0, 1, 0)
MinusBtn.Position = UDim2.new(0, 0, 0, 0)
MinusBtn.BackgroundColor3 = Color3.fromRGB(60, 90, 180)
MinusBtn.Text = "-"
MinusBtn.TextColor3 = Color3.fromRGB(255,255,255)
MinusBtn.TextSize = 14
MinusBtn.Font = Enum.Font.GothamBold
MinusBtn.Parent = InteractFreqFrame
local MinusCorner = Instance.new("UICorner")
MinusCorner.CornerRadius = UDim.new(0,4)
MinusCorner.Parent = MinusBtn

-- 重置按钮
local ResetBtn = Instance.new("TextButton")
ResetBtn.Name = "ResetBtn"
ResetBtn.Size = UDim2.new(0.38, 0, 1, 0)
ResetBtn.Position = UDim2.new(0.31, 0, 0, 0)
ResetBtn.BackgroundColor3 = Color3.fromRGB(50,50,55)
ResetBtn.Text = "重置"
ResetBtn.TextColor3 = Color3.fromRGB(200,200,200)
ResetBtn.TextSize = 10
ResetBtn.Font = Enum.Font.Gotham
ResetBtn.Parent = InteractFreqFrame
local ResetCorner = Instance.new("UICorner")
ResetCorner.CornerRadius = UDim.new(0,4)
ResetCorner.Parent = ResetBtn

-- 加号按钮
local PlusBtn = Instance.new("TextButton")
PlusBtn.Name = "PlusBtn"
PlusBtn.Size = UDim2.new(0.3, 0, 1, 0)
PlusBtn.Position = UDim2.new(0.7, 0, 0, 0)
PlusBtn.BackgroundColor3 = Color3.fromRGB(180, 90, 60)
PlusBtn.Text = "+"
PlusBtn.TextColor3 = Color3.fromRGB(255,255,255)
PlusBtn.TextSize = 14
PlusBtn.Font = Enum.Font.GothamBold
PlusBtn.Parent = InteractFreqFrame
local PlusCorner = Instance.new("UICorner")
PlusCorner.CornerRadius = UDim.new(0,4)
PlusCorner.Parent = PlusBtn

-- 攻击频率区域
local AttackFreqLabel = Instance.new("TextLabel")
AttackFreqLabel.Name = "AttackFreqLabel"
AttackFreqLabel.Size = UDim2.new(1, 0, 0, 20)
AttackFreqLabel.Position = UDim2.new(0, 0, 0, 130)
AttackFreqLabel.BackgroundTransparency = 1
AttackFreqLabel.Text = "攻击频率: 0.10秒"
AttackFreqLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
AttackFreqLabel.TextSize = 12
AttackFreqLabel.Font = Enum.Font.Gotham
AttackFreqLabel.TextXAlignment = Enum.TextXAlignment.Center
AttackFreqLabel.Parent = ContentFrame

-- 攻击频率按钮容器
local AttackFreqFrame = Instance.new("Frame")
AttackFreqFrame.Name = "AttackFreqFrame"
AttackFreqFrame.Size = UDim2.new(1, 0, 0, 18)
AttackFreqFrame.Position = UDim2.new(0, 0, 0, 150)
AttackFreqFrame.BackgroundTransparency = 1
AttackFreqFrame.Parent = ContentFrame

-- 攻击减号按钮
local AttackMinusBtn = Instance.new("TextButton")
AttackMinusBtn.Name = "AttackMinusBtn"
AttackMinusBtn.Size = UDim2.new(0.3, 0, 1, 0)
AttackMinusBtn.Position = UDim2.new(0, 0, 0, 0)
AttackMinusBtn.BackgroundColor3 = Color3.fromRGB(60, 90, 180)
AttackMinusBtn.Text = "-"
AttackMinusBtn.TextColor3 = Color3.fromRGB(255,255,255)
AttackMinusBtn.TextSize = 14
AttackMinusBtn.Font = Enum.Font.GothamBold
AttackMinusBtn.Parent = AttackFreqFrame
local AttackMinusCorner = Instance.new("UICorner")
AttackMinusCorner.CornerRadius = UDim.new(0,4)
AttackMinusCorner.Parent = AttackMinusBtn

-- 攻击重置按钮
local AttackResetBtn = Instance.new("TextButton")
AttackResetBtn.Name = "AttackResetBtn"
AttackResetBtn.Size = UDim2.new(0.38, 0, 1, 0)
AttackResetBtn.Position = UDim2.new(0.31, 0, 0, 0)
AttackResetBtn.BackgroundColor3 = Color3.fromRGB(50,50,55)
AttackResetBtn.Text = "重置"
AttackResetBtn.TextColor3 = Color3.fromRGB(200,200,200)
AttackResetBtn.TextSize = 10
AttackResetBtn.Font = Enum.Font.Gotham
AttackResetBtn.Parent = AttackFreqFrame
local AttackResetCorner = Instance.new("UICorner")
AttackResetCorner.CornerRadius = UDim.new(0,4)
AttackResetCorner.Parent = AttackResetBtn

-- 攻击加号按钮
local AttackPlusBtn = Instance.new("TextButton")
AttackPlusBtn.Name = "AttackPlusBtn"
AttackPlusBtn.Size = UDim2.new(0.3, 0, 1, 0)
AttackPlusBtn.Position = UDim2.new(0.7, 0, 0, 0)
AttackPlusBtn.BackgroundColor3 = Color3.fromRGB(180, 90, 60)
AttackPlusBtn.Text = "+"
AttackPlusBtn.TextColor3 = Color3.fromRGB(255,255,255)
AttackPlusBtn.TextSize = 14
AttackPlusBtn.Font = Enum.Font.GothamBold
AttackPlusBtn.Parent = AttackFreqFrame
local AttackPlusCorner = Instance.new("UICorner")
AttackPlusCorner.CornerRadius = UDim.new(0,4)
AttackPlusCorner.Parent = AttackPlusBtn

-- 添加到屏幕
AutoInteractUI.Parent = PlayerGui

-- 变量
local autoInteract = false
local autoAttack = false
local interactFreq = 0.25
local attackFreq = 0.10
local minFreq = 0.05
local maxFreq = 3.0
local isMinimized = false
local isDragging = false
local dragStartPos
local frameStartPos
local interactThread
local attackThread

-- 启用快速互动
local function enableFastInteract()
    for _, descendant in pairs(Workspace:GetDescendants()) do
        if descendant:IsA("ProximityPrompt") then
            descendant.HoldDuration = 0
        end
    end
    ProximityPromptService.PromptShown:Connect(function(prompt)
        if prompt:IsA("ProximityPrompt") then
            prompt.HoldDuration = 0
        end
    end)
end

-- 更新UI状态
local function updateUIState()
    if autoInteract then
        InteractToggle.Text = "自动互动：开启"
        InteractToggle.BackgroundColor3 = Color3.fromRGB(60, 200, 80)
    else
        InteractToggle.Text = "自动互动：关闭"
        InteractToggle.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
    end
    
    if autoAttack then
        AttackToggle.Text = "自动攻击：开启"
        AttackToggle.BackgroundColor3 = Color3.fromRGB(60, 200, 80)
    else
        AttackToggle.Text = "自动攻击：关闭"
        AttackToggle.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
    end
    
    InteractFreqLabel.Text = "互动频率: " .. string.format("%.2f", interactFreq) .. "秒"
    AttackFreqLabel.Text = "攻击频率: " .. string.format("%.2f", attackFreq) .. "秒"
end

-- 获取最近的玩家
local function getNearestPlayer()
    local localPos = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not localPos then return nil end
    local nearestPlayer = nil
    local nearestDistance = math.huge
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            local targetPos = player.Character:FindFirstChild("HumanoidRootPart")
            if targetPos then
                local distance = (targetPos.Position - localPos.Position).Magnitude
                if distance < nearestDistance then
                    nearestDistance = distance
                    nearestPlayer = player
                end
            end
        end
    end
    return nearestPlayer, nearestDistance
end

-- 切换自动互动（保持你的代码不变）
local function toggleAutoInteract()
    autoInteract = not autoInteract
    
    if interactThread then
        task.cancel(interactThread)
        interactThread = nil
    end
    
    if autoInteract then
        interactThread = task.spawn(function()
            while autoInteract do
                for _, descendant in pairs(workspace:GetDescendants()) do
                    if descendant:IsA("ProximityPrompt") then
                        fireproximityprompt(descendant)
                    end
                end
                task.wait(interactFreq)
            end
        end)
    end
    
    updateUIState()
end

-- 切换自动攻击（修复攻击功能）
local function toggleAutoAttack()
    autoAttack = not autoAttack
    
    if attackThread then
        task.cancel(attackThread)
        attackThread = nil
    end
    
    if autoAttack then
        attackThread = task.spawn(function()
            while autoAttack do
                local nearestPlayer, distance = getNearestPlayer()
                if nearestPlayer and distance < 50 then
                    local targetPos = nearestPlayer.Character:FindFirstChild("HumanoidRootPart")
                    if targetPos then
                        -- 1. 转动视角
                        local camera = Workspace.CurrentCamera
                        camera.CFrame = CFrame.new(camera.CFrame.Position, targetPos.Position)
                        
                        -- 2. 模拟鼠标右键攻击（修复版）
                        pcall(function()
                            -- 保存当前鼠标位置
                            local currentMousePos = UserInputService:GetMouseLocation()
                            
                            -- 模拟右键按下
                            VirtualInputManager:SendMouseButtonEvent(currentMousePos.X, currentMousePos.Y, 0, true, game, 1)
                            task.wait(0.05)
                            VirtualInputManager:SendMouseButtonEvent(currentMousePos.X, currentMousePos.Y, 0, false, game, 1)
                            
                            -- 如果游戏需要左键攻击，取消下面的注释
                            -- VirtualInputManager:SendMouseButtonEvent(currentMousePos.X, currentMousePos.Y, 0, true, game, 0)
                            -- task.wait(0.05)
                            -- VirtualInputManager:SendMouseButtonEvent(currentMousePos.X, currentMousePos.Y, 0, false, game, 0)
                        end)
                    end
                end
                task.wait(attackFreq)
            end
        end)
    end
    
    updateUIState()
end

-- 初始化
enableFastInteract()
updateUIState()

-- 绑定按钮事件
InteractToggle.MouseButton1Click:Connect(toggleAutoInteract)
AttackToggle.MouseButton1Click:Connect(toggleAutoAttack)

-- 互动频率调节按钮
MinusBtn.MouseButton1Click:Connect(function()
    interactFreq = math.max(minFreq, interactFreq - 0.05)
    updateUIState()
end)

PlusBtn.MouseButton1Click:Connect(function()
    interactFreq = math.min(maxFreq, interactFreq + 0.1)
    updateUIState()
end)

ResetBtn.MouseButton1Click:Connect(function()
    interactFreq = 0.25
    updateUIState()
end)

-- 攻击频率调节按钮
AttackMinusBtn.MouseButton1Click:Connect(function()
    attackFreq = math.max(minFreq, attackFreq - 0.05)
    updateUIState()
end)

AttackPlusBtn.MouseButton1Click:Connect(function()
    attackFreq = math.min(maxFreq, attackFreq + 0.1)
    updateUIState()
end)

AttackResetBtn.MouseButton1Click:Connect(function()
    attackFreq = 0.10
    updateUIState()
end)

-- 关闭按钮
CloseButton.MouseButton1Click:Connect(function()
    AutoInteractUI:Destroy()
    autoInteract = false
    autoAttack = false
    if interactThread then
        task.cancel(interactThread)
        interactThread = nil
    end
    if attackThread then
        task.cancel(attackThread)
        attackThread = nil
    end
end)

-- 最小化按钮
MinimizeButton.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    if isMinimized then
        ContentFrame.Visible = false
        MainFrame.Size = UDim2.new(0, 220, 0, 25)
        MinimizeButton.Text = "＋"
    else
        ContentFrame.Visible = true
        MainFrame.Size = UDim2.new(0, 220, 0, 240)
        MinimizeButton.Text = "—"
    end
end)

-- 窗口拖动功能
TitleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        isDragging = true
        dragStartPos = input.Position
        frameStartPos = MainFrame.Position
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if isDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStartPos
        MainFrame.Position = UDim2.new(
            frameStartPos.X.Scale, 
            frameStartPos.X.Offset + delta.X,
            frameStartPos.Y.Scale, 
            frameStartPos.Y.Offset + delta.Y
        )
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        isDragging = false
    end
end)

-- 测试用：如果右键无效可以尝试左键攻击
-- 取消下面这行的注释来切换为左键攻击
-- local USE_LEFT_CLICK = true

print("✅ 顶级刷票脚本已加载 - 攻击功能已修复")