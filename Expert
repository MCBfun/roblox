-- Expert
local SoundService = game:GetService("SoundService")

-- 创建音频实例
local sound = Instance.new("Sound")
sound.SoundId = "rbxassetid://7390036132"  -- 替换为你的音频ID
sound.Parent = SoundService

-- 播放音频
sound:Play()
-- Expert - 等候厅传送脚本
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local isRunning = true

-- 创建最小化UI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ExpertGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 120, 0, 295)
mainFrame.Position = UDim2.new(0.02, 0, 0.3, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)  -- 改为深灰色
mainFrame.BackgroundTransparency = 0.1
mainFrame.BorderSizePixel = 1
mainFrame.BorderColor3 = Color3.fromRGB(60, 60, 70)  -- 改为深灰色边框
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.ClipsDescendants = true
mainFrame.Parent = screenGui

-- 圆角效果
local uiCorner = Instance.new("UICorner")
uiCorner.CornerRadius = UDim.new(0, 6)
uiCorner.Parent = mainFrame

-- 标题栏
local titleBar = Instance.new("Frame")
titleBar.Name = "TitleBar"
titleBar.Size = UDim2.new(1, 0, 0, 25)
titleBar.BackgroundColor3 = Color3.fromRGB(20, 20, 25)  -- 改为深灰色
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

-- 标题栏圆角
local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 6)
titleCorner.Parent = titleBar

local title = Instance.new("TextLabel")
title.Text = "Expert"
title.Size = UDim2.new(1, -80, 1, 0)
title.Position = UDim2.new(0, 5, 0, 0)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.fromRGB(220, 220, 220)  -- 改为浅灰色
title.TextXAlignment = Enum.TextXAlignment.Left
title.Font = Enum.Font.SourceSansSemibold
title.TextSize = 14
title.Parent = titleBar

-- 控制按钮容器
local controlButtons = Instance.new("Frame")
controlButtons.Name = "ControlButtons"
controlButtons.Size = UDim2.new(0, 75, 1, 0)
controlButtons.Position = UDim2.new(1, -75, 0, 0)
controlButtons.BackgroundTransparency = 1
controlButtons.Parent = titleBar

-- 缩放按钮
local zoomBtn = Instance.new("TextButton")
zoomBtn.Name = "ZoomButton"
zoomBtn.Size = UDim2.new(0, 25, 0, 25)
zoomBtn.Position = UDim2.new(0, 0, 0, 0)
zoomBtn.Text = "⏺️"
zoomBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 45)  -- 改为深灰色
zoomBtn.TextColor3 = Color3.fromRGB(220, 220, 220)  -- 改为浅灰色
zoomBtn.Font = Enum.Font.SourceSansBold
zoomBtn.TextSize = 14
zoomBtn.AutoButtonColor = false
zoomBtn.Parent = controlButtons

local zoomCorner = Instance.new("UICorner")
zoomCorner.CornerRadius = UDim.new(0, 4)
zoomCorner.Parent = zoomBtn

-- 缩小按钮
local minimizeBtn = Instance.new("TextButton")
minimizeBtn.Name = "MinimizeButton"
minimizeBtn.Size = UDim2.new(0, 25, 0, 25)
minimizeBtn.Position = UDim2.new(0, 25, 0, 0)
minimizeBtn.Text = "_"
minimizeBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 45)  -- 改为深灰色
minimizeBtn.TextColor3 = Color3.fromRGB(220, 220, 220)  -- 改为浅灰色
minimizeBtn.Font = Enum.Font.SourceSansBold
minimizeBtn.TextSize = 16
minimizeBtn.AutoButtonColor = false
minimizeBtn.Parent = controlButtons

local minimizeCorner = Instance.new("UICorner")
minimizeCorner.CornerRadius = UDim.new(0, 4)
minimizeCorner.Parent = minimizeBtn

-- 关闭按钮
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 25, 0, 25)
closeBtn.Position = UDim2.new(0, 50, 0, 0)
closeBtn.Text = "×"
closeBtn.BackgroundColor3 = Color3.fromRGB(45, 35, 35)  -- 改为深灰色偏红
closeBtn.TextColor3 = Color3.fromRGB(220, 220, 220)  -- 改为浅灰色
closeBtn.Font = Enum.Font.SourceSansBold
closeBtn.TextSize = 16
closeBtn.AutoButtonColor = false
closeBtn.Parent = controlButtons

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0, 4)
closeCorner.Parent = closeBtn

-- 等候厅传送按钮
local backroomTeleportButton = Instance.new("TextButton")
backroomTeleportButton.Name = "BackroomTeleportButton"
backroomTeleportButton.Size = UDim2.new(1, -10, 0, 40)
backroomTeleportButton.Position = UDim2.new(0, 5, 0, 30)
backroomTeleportButton.Text = "传送等候厅"
backroomTeleportButton.BackgroundColor3 = Color3.fromRGB(35, 35, 40)  -- 改为深灰色
backroomTeleportButton.TextColor3 = Color3.fromRGB(220, 220, 220)  -- 改为浅灰色
backroomTeleportButton.Font = Enum.Font.SourceSansSemibold
backroomTeleportButton.TextSize = 14
backroomTeleportButton.TextWrapped = true
backroomTeleportButton.AutoButtonColor = false
backroomTeleportButton.Parent = mainFrame

local teleportCorner = Instance.new("UICorner")
teleportCorner.CornerRadius = UDim.new(0, 5)
teleportCorner.Parent = backroomTeleportButton

-- 剧院|工厂火车传送按钮（合并）
local theaterFactoryButton = Instance.new("TextButton")
theaterFactoryButton.Name = "TheaterFactoryButton"
theaterFactoryButton.Size = UDim2.new(1, -10, 0, 40)
theaterFactoryButton.Position = UDim2.new(0, 5, 0, 75)
theaterFactoryButton.Text = "传送剧院工厂"
theaterFactoryButton.BackgroundColor3 = Color3.fromRGB(35, 35, 40)  -- 改为深灰色
theaterFactoryButton.TextColor3 = Color3.fromRGB(220, 220, 220)  -- 改为浅灰色
theaterFactoryButton.Font = Enum.Font.SourceSansSemibold
theaterFactoryButton.TextSize = 14
theaterFactoryButton.TextWrapped = true
theaterFactoryButton.AutoButtonColor = false
theaterFactoryButton.Parent = mainFrame

local theaterFactoryCorner = Instance.new("UICorner")
theaterFactoryCorner.CornerRadius = UDim.new(0, 5)
theaterFactoryCorner.Parent = theaterFactoryButton

-- 下水道传送按钮
local sewerTeleportButton = Instance.new("TextButton")
sewerTeleportButton.Name = "SewerTeleportButton"
sewerTeleportButton.Size = UDim2.new(1, -10, 0, 40)
sewerTeleportButton.Position = UDim2.new(0, 5, 0, 120)
sewerTeleportButton.Text = "传送下水道"
sewerTeleportButton.BackgroundColor3 = Color3.fromRGB(35, 35, 40)  -- 改为深灰色
sewerTeleportButton.TextColor3 = Color3.fromRGB(220, 220, 220)  -- 改为浅灰色
sewerTeleportButton.Font = Enum.Font.SourceSansSemibold
sewerTeleportButton.TextSize = 14
sewerTeleportButton.TextWrapped = true
sewerTeleportButton.AutoButtonColor = false
sewerTeleportButton.Parent = mainFrame

local sewerCorner = Instance.new("UICorner")
sewerCorner.CornerRadius = UDim.new(0, 5)
sewerCorner.Parent = sewerTeleportButton

-- 自救功能按钮
local selfRescueButton = Instance.new("TextButton")
selfRescueButton.Name = "SelfRescueButton"
selfRescueButton.Size = UDim2.new(1, -10, 0, 40)
selfRescueButton.Position = UDim2.new(0, 5, 0, 165)
selfRescueButton.Text = "固定位置 [关]"
selfRescueButton.BackgroundColor3 = Color3.fromRGB(35, 35, 40)  -- 改为深灰色
selfRescueButton.TextColor3 = Color3.fromRGB(220, 220, 220)  -- 改为浅灰色
selfRescueButton.Font = Enum.Font.SourceSansSemibold
selfRescueButton.TextSize = 14
selfRescueButton.TextWrapped = true
selfRescueButton.AutoButtonColor = false
selfRescueButton.Parent = mainFrame

local selfRescueCorner = Instance.new("UICorner")
selfRescueCorner.CornerRadius = UDim.new(0, 5)
selfRescueCorner.Parent = selfRescueButton

-- 仙人模式按钮
local ninjaModeButton = Instance.new("TextButton")
ninjaModeButton.Name = "NinjaModeButton"
ninjaModeButton.Size = UDim2.new(1, -10, 0, 40)
ninjaModeButton.Position = UDim2.new(0, 5, 0, 210)
ninjaModeButton.Text = "仙人模式 [关]"
ninjaModeButton.BackgroundColor3 = Color3.fromRGB(35, 35, 40)  -- 改为深灰色
ninjaModeButton.TextColor3 = Color3.fromRGB(220, 220, 220)  -- 改为浅灰色
ninjaModeButton.Font = Enum.Font.SourceSansSemibold
ninjaModeButton.TextSize = 14
ninjaModeButton.TextWrapped = true
ninjaModeButton.AutoButtonColor = false
ninjaModeButton.Parent = mainFrame

local ninjaModeCorner = Instance.new("UICorner")
ninjaModeCorner.CornerRadius = UDim.new(0, 5)
ninjaModeCorner.Parent = ninjaModeButton

-- 状态显示（缩小后）
local statusLabel = Instance.new("TextLabel")
statusLabel.Name = "StatusLabel"
statusLabel.Size = UDim2.new(1, -10, 1, -10)
statusLabel.Position = UDim2.new(0, 5, 0, 5)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "Expert\n点击展开"
statusLabel.TextColor3 = Color3.fromRGB(180, 180, 180)  -- 改为灰色
statusLabel.TextSize = 12
statusLabel.TextWrapped = true
statusLabel.Visible = false
statusLabel.Parent = mainFrame

-- 变量
local isMinimized = false
local isZoomed = false
local originalSize = mainFrame.Size
local originalPosition = mainFrame.Position
local minimizedSize = UDim2.new(0, 80, 0, 40)
local zoomedSize = UDim2.new(0, 140, 0, 305)

-- 自救功能相关变量
local isSelfRescueActive = false
local selfRescueConnection = nil
local savedPosition = nil
local savedCFrame = nil

-- 仙人模式相关变量
local isNinjaModeActive = false
local originalWalkSpeed = 16
local originalJumpPower = 50
local ninjaModeMultiplier = 2.5
local infiniteJumpEnabled = false
local ninjaModeConnection = nil

-- 坐标定义
local backroomLocation = {X = 163.15, Y = 9, Z = 955.4}
local theaterFactoryLocation = {X = 0, Y = -297, Z = 0}  -- Y-297位置
local sewerLocation = {X = 356, Y = 528, Z = -179}

-- 按钮悬停效果函数（黑白风格）
local function setupButtonHover(button)
    local originalColor = button.BackgroundColor3
    local originalTextColor = button.TextColor3
    button.MouseEnter:Connect(function()
        button.BackgroundColor3 = Color3.fromRGB(
            math.min(originalColor.R * 255 + 15, 55),
            math.min(originalColor.G * 255 + 15, 55),
            math.min(originalColor.B * 255 + 15, 55)
        ) / 255
        button.TextColor3 = Color3.fromRGB(240, 240, 240)  -- 更亮的灰色
    end)
    button.MouseLeave:Connect(function()
        button.BackgroundColor3 = originalColor
        button.TextColor3 = originalTextColor
    end)
end

setupButtonHover(backroomTeleportButton)
setupButtonHover(theaterFactoryButton)
setupButtonHover(sewerTeleportButton)
setupButtonHover(selfRescueButton)
setupButtonHover(ninjaModeButton)
setupButtonHover(zoomBtn)
setupButtonHover(minimizeBtn)
setupButtonHover(closeBtn)

-- 自救功能
local function startSelfRescue()
    if isSelfRescueActive then return end
    
    local character = player.Character
    if not character then return false end

    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return false end

    savedPosition = humanoidRootPart.Position
    savedCFrame = humanoidRootPart.CFrame
    isSelfRescueActive = true
    selfRescueButton.Text = "固定位置 [开]"

    local bodyPosition = Instance.new("BodyPosition")
    bodyPosition.Name = "ExpertSelfRescuePosition"
    bodyPosition.P = 100000
    bodyPosition.D = 1000
    bodyPosition.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
    bodyPosition.Position = savedPosition
    bodyPosition.Parent = humanoidRootPart

    local humanoid = character:FindFirstChild("Humanoid")
    if humanoid then
        humanoid.WalkSpeed = 0
        humanoid.JumpPower = 0
    end

    selfRescueConnection = RunService.Heartbeat:Connect(function()
        if not isSelfRescueActive or not character or character.Parent == nil then
            stopSelfRescue()
            return
        end
        local currentRootPart = character:FindFirstChild("HumanoidRootPart")
        if not currentRootPart then return end
        currentRootPart.CFrame = savedCFrame
        local existingBodyPosition = currentRootPart:FindFirstChild("ExpertSelfRescuePosition")
        if existingBodyPosition then
            existingBodyPosition.Position = savedPosition
        else
            local newBodyPosition = Instance.new("BodyPosition")
            newBodyPosition.Name = "ExpertSelfRescuePosition"
            newBodyPosition.P = 100000
            newBodyPosition.D = 1000
            newBodyPosition.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
            newBodyPosition.Position = savedPosition
            newBodyPosition.Parent = currentRootPart
        end
    end)
    
    if isMinimized then statusLabel.Text = "已固定位置" end
    return true
end

local function stopSelfRescue()
    if not isSelfRescueActive then return end
    isSelfRescueActive = false
    if selfRescueConnection then
        selfRescueConnection:Disconnect()
        selfRescueConnection = nil
    end
    
    local character = player.Character
    if character then
        local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
        if humanoidRootPart then
            local bodyPosition = humanoidRootPart:FindFirstChild("ExpertSelfRescuePosition")
            if bodyPosition then bodyPosition:Destroy() end
        end
        local humanoid = character:FindFirstChild("Humanoid")
        if humanoid then
            humanoid.WalkSpeed = 16
            humanoid.JumpPower = 50
        end
    end
    
    selfRescueButton.Text = "固定位置 [关]"
    if isMinimized then statusLabel.Text = "Expert\n点击展开" end
    savedPosition = nil
    savedCFrame = nil
end

-- 通用传送函数
local function performTeleport(location, button, locationName)
    if isSelfRescueActive then stopSelfRescue() end
    
    local character = player.Character
    if not character then return false end

    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return false end

    local teleportPos = Vector3.new(location.X, location.Y, location.Z)
    humanoidRootPart.CFrame = CFrame.new(teleportPos)

    if not isMinimized and button then
        local originalText = button.Text
        button.Text = "✅ 已传送"
        task.wait(2)
        button.Text = originalText
    end

    if isMinimized then
        statusLabel.Text = "✅ 已传送" .. locationName
        task.wait(2)
        statusLabel.Text = "Expert\n点击展开"
    end

    return true
end

-- 执行等候厅传送
local function performBackroomTeleport()
    return performTeleport(backroomLocation, backroomTeleportButton, "传送等候厅")
end

-- 执行剧院|工厂传送（Y-297）
local function performTheaterFactoryTeleport()
    return performTeleport(theaterFactoryLocation, theaterFactoryButton, "传送剧院工厂")
end

-- 执行下水道传送
local function performSewerTeleport()
    return performTeleport(sewerLocation, sewerTeleportButton, "传送下水道")
end

-- 仙人模式功能
local function startNinjaMode()
    if isNinjaModeActive then return end
    
    local character = player.Character
    if not character then return false end

    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return false end

    originalWalkSpeed = humanoid.WalkSpeed
    originalJumpPower = humanoid.JumpPower
    isNinjaModeActive = true
    infiniteJumpEnabled = true
    ninjaModeButton.Text = "仙人模式[开]"
    
    humanoid.WalkSpeed = originalWalkSpeed * ninjaModeMultiplier
    humanoid.JumpPower = originalJumpPower * 3

    ninjaModeConnection = UserInputService.JumpRequest:Connect(function()
        if infiniteJumpEnabled and character and character:FindFirstChild("Humanoid") then
            character.Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
        end
    end)
    
    if isMinimized then statusLabel.Text = "仙人模式" end
    return true
end

local function stopNinjaMode()
    if not isNinjaModeActive then return end
    isNinjaModeActive = false
    infiniteJumpEnabled = false
    
    if ninjaModeConnection then
        ninjaModeConnection:Disconnect()
        ninjaModeConnection = nil
    end
    
    local character = player.Character
    if character then
        local humanoid = character:FindFirstChild("Humanoid")
        if humanoid then
            humanoid.WalkSpeed = originalWalkSpeed
            humanoid.JumpPower = originalJumpPower
        end
    end
    
    ninjaModeButton.Text = "仙人模式[关]"
    if isMinimized then statusLabel.Text = "Expert\n点击展开" end
end

-- 按钮点击事件
backroomTeleportButton.MouseButton1Click:Connect(performBackroomTeleport)
theaterFactoryButton.MouseButton1Click:Connect(performTheaterFactoryTeleport)
sewerTeleportButton.MouseButton1Click:Connect(performSewerTeleport)
selfRescueButton.MouseButton1Click:Connect(function()
    if isSelfRescueActive then stopSelfRescue() else startSelfRescue() end
end)
ninjaModeButton.MouseButton1Click:Connect(function()
    if isNinjaModeActive then stopNinjaMode() else startNinjaMode() end
end)

-- 缩放功能
zoomBtn.MouseButton1Click:Connect(function()
    isZoomed = not isZoomed
    if isZoomed then
        local currentPos = mainFrame.Position
        local tween = TweenService:Create(mainFrame, TweenInfo.new(0.3), {
            Size = zoomedSize, Position = currentPos
        })
        tween:Play()
        zoomBtn.Text = "⏺"
    else
        local currentPos = mainFrame.Position
        local tween = TweenService:Create(mainFrame, TweenInfo.new(0.3), {
            Size = originalSize, Position = currentPos
        })
        tween:Play()
        zoomBtn.Text = "⏺️"
    end
end)

-- 缩小功能
minimizeBtn.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    if isMinimized then
        local currentPos = mainFrame.Position
        local tween = TweenService:Create(mainFrame, TweenInfo.new(0.3), {
            Size = minimizedSize, Position = currentPos
        })
        tween:Play()
        tween.Completed:Wait()
        backroomTeleportButton.Visible = false
        theaterFactoryButton.Visible = false
        sewerTeleportButton.Visible = false
        selfRescueButton.Visible = false
        ninjaModeButton.Visible = false
        statusLabel.Visible = true
        minimizeBtn.Text = "+"
        title.Text = "⚔"
        if isSelfRescueActive then
            statusLabel.Text = "固定位置"
        elseif isNinjaModeActive then
            statusLabel.Text = "仙人模式"
        else
            statusLabel.Text = "Expert\n点击展开"
        end
    else
        backroomTeleportButton.Visible = true
        theaterFactoryButton.Visible = true
        sewerTeleportButton.Visible = true
        selfRescueButton.Visible = true
        ninjaModeButton.Visible = true
        statusLabel.Visible = false
        minimizeBtn.Text = "_"
        title.Text = "Expert"
        local currentPos = mainFrame.Position
        local targetSize = isZoomed and zoomedSize or originalSize
        local tween = TweenService:Create(mainFrame, TweenInfo.new(0.3), {
            Size = targetSize, Position = currentPos
        })
        tween:Play()
    end
end)

-- 关闭功能
closeBtn.MouseButton1Click:Connect(function()
    if isSelfRescueActive then stopSelfRescue() end
    if isNinjaModeActive then stopNinjaMode() end
    local tween = TweenService:Create(mainFrame, TweenInfo.new(0.3), {
        BackgroundTransparency = 0.8,
        Position = mainFrame.Position + UDim2.new(0, 0, 0, -20)
    })
    tween:Play()
    tween.Completed:Wait()
    screenGui:Destroy()
    isRunning = false
end)

-- 快捷键
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.B then performBackroomTeleport()
    elseif input.KeyCode == Enum.KeyCode.T then performTheaterFactoryTeleport()
    elseif input.KeyCode == Enum.KeyCode.S then performSewerTeleport()
    elseif input.KeyCode == Enum.KeyCode.R then
        if isSelfRescueActive then stopSelfRescue() else startSelfRescue() end
    elseif input.KeyCode == Enum.KeyCode.N then
        if isNinjaModeActive then stopNinjaMode() else startNinjaMode() end
    end
end)

-- 角色重生处理
player.CharacterAdded:Connect(function(character)
    if isSelfRescueActive then stopSelfRescue() end
    if isNinjaModeActive then
        task.wait(0.5)
        if isNinjaModeActive then
            local humanoid = character:FindFirstChild("Humanoid")
            if humanoid then
                humanoid.WalkSpeed = originalWalkSpeed * ninjaModeMultiplier
                humanoid.JumpPower = originalJumpPower * 3
                if ninjaModeConnection then ninjaModeConnection:Disconnect() end
                ninjaModeConnection = UserInputService.JumpRequest:Connect(function()
                    if infiniteJumpEnabled and character and character:FindFirstChild("Humanoid") then
                        character.Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
                    end
                end)
            end
        end
    end
end)

-- 初始淡入动画
local originalPosition = UDim2.new(0.02, 0, 0.3, 0)
mainFrame.BackgroundTransparency = 1
mainFrame.Position = originalPosition + UDim2.new(0, 0, 0, -30)
task.wait(0.1)
local fadeInTween = TweenService:Create(mainFrame, TweenInfo.new(0.5), {
    BackgroundTransparency = 0.1, Position = originalPosition
})
fadeInTween:Play()

game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "Expert",
    Text = "脚本已加载 - B/T/S/R/N键",
    Duration = 3,
    Position = UDim2.new(0, 20, 1, -50)
})