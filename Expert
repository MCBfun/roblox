-- Expert - ç­‰å€™å…ä¼ é€è„šæœ¬
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local isRunning = true

-- åˆ›å»ºæœ€å°åŒ–UI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ExpertGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 120, 0, 250)  -- å¢åŠ é«˜åº¦ä¸º250ï¼Œå®¹çº³å››ä¸ªæŒ‰é’®
mainFrame.Position = UDim2.new(0.02, 0, 0.3, 0)  -- æ”¹ä¸ºå›ºå®šä½ç½®ï¼Œè€Œä¸æ˜¯ä½¿ç”¨AnchorPoint
mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 55)
mainFrame.BackgroundTransparency = 0.2
mainFrame.BorderSizePixel = 1
mainFrame.BorderColor3 = Color3.fromRGB(80, 80, 100)
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.ClipsDescendants = true
mainFrame.Parent = screenGui

-- åœ†è§’æ•ˆæœ
local uiCorner = Instance.new("UICorner")
uiCorner.CornerRadius = UDim.new(0, 6)
uiCorner.Parent = mainFrame

-- æ ‡é¢˜æ 
local titleBar = Instance.new("Frame")
titleBar.Name = "TitleBar"
titleBar.Size = UDim2.new(1, 0, 0, 25)
titleBar.BackgroundColor3 = Color3.fromRGB(30, 30, 45)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

-- æ ‡é¢˜æ åœ†è§’
local titleCorner = Instance.new("UICorner")
titleCorner.CornerRadius = UDim.new(0, 6)
titleCorner.Parent = titleBar

local title = Instance.new("TextLabel")
title.Text = "Expert"
title.Size = UDim2.new(1, -80, 1, 0)
title.Position = UDim2.new(0, 5, 0, 0)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextXAlignment = Enum.TextXAlignment.Left
title.Font = Enum.Font.SourceSansSemibold
title.TextSize = 14
title.Parent = titleBar

-- æ§åˆ¶æŒ‰é’®å®¹å™¨ï¼ˆç°åœ¨æœ‰3ä¸ªæŒ‰é’®ï¼‰
local controlButtons = Instance.new("Frame")
controlButtons.Name = "ControlButtons"
controlButtons.Size = UDim2.new(0, 75, 1, 0)
controlButtons.Position = UDim2.new(1, -75, 0, 0)
controlButtons.BackgroundTransparency = 1
controlButtons.Parent = titleBar

-- ç¼©æ”¾æŒ‰é’®ï¼ˆæ–°å¢ï¼‰
local zoomBtn = Instance.new("TextButton")
zoomBtn.Name = "ZoomButton"
zoomBtn.Size = UDim2.new(0, 25, 0, 25)
zoomBtn.Position = UDim2.new(0, 0, 0, 0)
zoomBtn.Text = "âºï¸"
zoomBtn.BackgroundColor3 = Color3.fromRGB(60, 100, 180)
zoomBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
zoomBtn.Font = Enum.Font.SourceSansBold
zoomBtn.TextSize = 14
zoomBtn.AutoButtonColor = false
zoomBtn.Parent = controlButtons

-- ç¼©å°æŒ‰é’®
local minimizeBtn = Instance.new("TextButton")
minimizeBtn.Name = "MinimizeButton"
minimizeBtn.Size = UDim2.new(0, 25, 0, 25)
minimizeBtn.Position = UDim2.new(0, 25, 0, 0)
minimizeBtn.Text = "_"
minimizeBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
minimizeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
minimizeBtn.Font = Enum.Font.SourceSansBold
minimizeBtn.TextSize = 16
minimizeBtn.AutoButtonColor = false
minimizeBtn.Parent = controlButtons

-- å…³é—­æŒ‰é’®
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 25, 0, 25)
closeBtn.Position = UDim2.new(0, 50, 0, 0)
closeBtn.Text = "Ã—"
closeBtn.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
closeBtn.Font = Enum.Font.SourceSansBold
closeBtn.TextSize = 16
closeBtn.AutoButtonColor = false
closeBtn.Parent = controlButtons

-- ç­‰å€™å…ä¼ é€æŒ‰é’®
local backroomTeleportButton = Instance.new("TextButton")
backroomTeleportButton.Name = "BackroomTeleportButton"
backroomTeleportButton.Size = UDim2.new(1, -10, 0, 40)
backroomTeleportButton.Position = UDim2.new(0, 5, 0, 30)
backroomTeleportButton.Text = "ä¼ é€ç­‰å€™å…"
backroomTeleportButton.BackgroundColor3 = Color3.fromRGB(60, 180, 100)  -- ç»¿è‰²
backroomTeleportButton.TextColor3 = Color3.fromRGB(255, 255, 255)
backroomTeleportButton.Font = Enum.Font.SourceSansSemibold
backroomTeleportButton.TextSize = 14
backroomTeleportButton.TextWrapped = true
backroomTeleportButton.AutoButtonColor = false
backroomTeleportButton.Parent = mainFrame

-- æ·»åŠ åœ†è§’
local teleportCorner = Instance.new("UICorner")
teleportCorner.CornerRadius = UDim.new(0, 5)
teleportCorner.Parent = backroomTeleportButton

-- å‰§é™¢ç«è½¦ä¼ é€æŒ‰é’®
local theaterTrainButton = Instance.new("TextButton")
theaterTrainButton.Name = "TheaterTrainButton"
theaterTrainButton.Size = UDim2.new(1, -10, 0, 40)
theaterTrainButton.Position = UDim2.new(0, 5, 0, 75)
theaterTrainButton.Text = "ä¼ é€å‰§é™¢ç«è½¦"
theaterTrainButton.BackgroundColor3 = Color3.fromRGB(180, 100, 60)  -- æ©™è‰²
theaterTrainButton.TextColor3 = Color3.fromRGB(255, 255, 255)
theaterTrainButton.Font = Enum.Font.SourceSansSemibold
theaterTrainButton.TextSize = 14
theaterTrainButton.TextWrapped = true
theaterTrainButton.AutoButtonColor = false
theaterTrainButton.Parent = mainFrame

-- æ·»åŠ åœ†è§’
local theaterTrainCorner = Instance.new("UICorner")
theaterTrainCorner.CornerRadius = UDim.new(0, 5)
theaterTrainCorner.Parent = theaterTrainButton

-- å·¥å‚ç«è½¦ä¼ é€æŒ‰é’®
local factoryTrainButton = Instance.new("TextButton")
factoryTrainButton.Name = "FactoryTrainButton"
factoryTrainButton.Size = UDim2.new(1, -10, 0, 40)
factoryTrainButton.Position = UDim2.new(0, 5, 0, 120)
factoryTrainButton.Text = "ä¼ é€å·¥å‚ç«è½¦"
factoryTrainButton.BackgroundColor3 = Color3.fromRGB(100, 100, 200)  -- è“è‰²
factoryTrainButton.TextColor3 = Color3.fromRGB(255, 255, 255)
factoryTrainButton.Font = Enum.Font.SourceSansSemibold
factoryTrainButton.TextSize = 14
factoryTrainButton.TextWrapped = true
factoryTrainButton.AutoButtonColor = false
factoryTrainButton.Parent = mainFrame

-- æ·»åŠ åœ†è§’
local factoryTrainCorner = Instance.new("UICorner")
factoryTrainCorner.CornerRadius = UDim.new(0, 5)
factoryTrainCorner.Parent = factoryTrainButton

-- === æ–°å¢ï¼šè‡ªæ•‘åŠŸèƒ½æŒ‰é’® ===
local selfRescueButton = Instance.new("TextButton")
selfRescueButton.Name = "SelfRescueButton"
selfRescueButton.Size = UDim2.new(1, -10, 0, 40)
selfRescueButton.Position = UDim2.new(0, 5, 0, 165)
selfRescueButton.Text = "è‡ªæ•‘\nå›ºå®šä½ç½® [OFF]"
selfRescueButton.BackgroundColor3 = Color3.fromRGB(180, 60, 180)  -- ç´«è‰²
selfRescueButton.TextColor3 = Color3.fromRGB(255, 255, 255)
selfRescueButton.Font = Enum.Font.SourceSansSemibold
selfRescueButton.TextSize = 14
selfRescueButton.TextWrapped = true
selfRescueButton.AutoButtonColor = false
selfRescueButton.Parent = mainFrame

-- æ·»åŠ åœ†è§’
local selfRescueCorner = Instance.new("UICorner")
selfRescueCorner.CornerRadius = UDim.new(0, 5)
selfRescueCorner.Parent = selfRescueButton

-- çŠ¶æ€æ˜¾ç¤ºï¼ˆç¼©å°åï¼‰
local statusLabel = Instance.new("TextLabel")
statusLabel.Name = "StatusLabel"
statusLabel.Size = UDim2.new(1, -10, 1, -10)
statusLabel.Position = UDim2.new(0, 5, 0, 5)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "Expert\nç‚¹å‡»å±•å¼€"
statusLabel.TextColor3 = Color3.fromRGB(200, 200, 220)
statusLabel.TextSize = 12
statusLabel.TextWrapped = true
statusLabel.Visible = false
statusLabel.Parent = mainFrame

-- å˜é‡
local isMinimized = false
local isZoomed = false  -- æ–°å¢ï¼šç¼©æ”¾çŠ¶æ€
local originalSize = mainFrame.Size
local originalPosition = mainFrame.Position  -- ä¿å­˜åŸå§‹ä½ç½®
local minimizedSize = UDim2.new(0, 80, 0, 40)  -- æ›´å°çš„ç¼©å°æ¨¡å¼
local zoomedSize = UDim2.new(0, 140, 0, 260)  -- è°ƒæ•´æ”¾å¤§åçš„å°ºå¯¸ï¼ˆé«˜åº¦è°ƒæ•´ä¸º260ï¼‰

-- === æ–°å¢ï¼šè‡ªæ•‘åŠŸèƒ½ç›¸å…³å˜é‡ ===
local isSelfRescueActive = false
local selfRescueConnection = nil
local savedPosition = nil
local savedCFrame = nil

-- ç­‰å€™å…åæ ‡
local backroomLocation = {
    X = 163.15,
    Y = 9,
    Z = 955.4
}

-- å‰§é™¢ç«è½¦åæ ‡
local theaterTrainLocation = {
    X = -5.4,
    Y = 73,
    Z = -145.3
}

-- å·¥å‚ç«è½¦åæ ‡
local factoryTrainLocation = {
    X = 300,
    Y = 17,
    Z = 475
}

-- æŒ‰é’®æ‚¬åœæ•ˆæœå‡½æ•°
local function setupButtonHover(button)
    local originalColor = button.BackgroundColor3

    button.MouseEnter:Connect(function()
        local tween = TweenService:Create(button, TweenInfo.new(0.2), {
            BackgroundColor3 = Color3.fromRGB(
                math.min(255, originalColor.R * 255 + 30),
                math.min(255, originalColor.G * 255 + 30),
                math.min(255, originalColor.B * 255 + 30)
            )
        })
        tween:Play()
    end)

    button.MouseLeave:Connect(function()
        local tween = TweenService:Create(button, TweenInfo.new(0.2), {
            BackgroundColor3 = originalColor
        })
        tween:Play()
    end)
end

-- åº”ç”¨æ‚¬åœæ•ˆæœ
setupButtonHover(backroomTeleportButton)
setupButtonHover(theaterTrainButton)
setupButtonHover(factoryTrainButton)
setupButtonHover(selfRescueButton)  -- æ–°å¢
setupButtonHover(zoomBtn)
setupButtonHover(minimizeBtn)
setupButtonHover(closeBtn)

-- === æ–°å¢ï¼šè‡ªæ•‘åŠŸèƒ½ ===
local function startSelfRescue()
    if isSelfRescueActive then return end
    
    local character = player.Character
    if not character then 
        print("[Expert] é”™è¯¯: è§’è‰²ä¸å­˜åœ¨")
        return false
    end

    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then 
        print("[Expert] é”™è¯¯: æ‰¾ä¸åˆ°HumanoidRootPart")
        return false
    end

    -- ä¿å­˜å½“å‰ä½ç½®
    savedPosition = humanoidRootPart.Position
    savedCFrame = humanoidRootPart.CFrame
    
    isSelfRescueActive = true
    selfRescueButton.Text = "è‡ªæ•‘\nå›ºå®šä½ç½® [ON]"
    selfRescueButton.BackgroundColor3 = Color3.fromRGB(150, 30, 150)  -- æ·±ç´«è‰²è¡¨ç¤ºæ¿€æ´»
    
    print("[Expert] å¼€å§‹è‡ªæ•‘åŠŸèƒ½ - ä½ç½®å·²å›ºå®š")
    print(string.format("å›ºå®šä½ç½®: X:%.2f, Y:%.2f, Z:%.2f", 
        savedPosition.X, savedPosition.Y, savedPosition.Z))

    -- æ–¹æ³•1ï¼šä½¿ç”¨BodyPositionå¼ºåˆ¶å›ºå®šä½ç½®ï¼ˆæœ€æœ‰æ•ˆï¼‰
    local bodyPosition = Instance.new("BodyPosition")
    bodyPosition.Name = "ExpertSelfRescuePosition"
    bodyPosition.P = 100000  -- æœ€å¤§åŠ›åº¦
    bodyPosition.D = 1000    -- é˜»å°¼
    bodyPosition.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
    bodyPosition.Position = savedPosition
    bodyPosition.Parent = humanoidRootPart

    -- æ–¹æ³•2ï¼šç¦ç”¨Humanoidç§»åŠ¨
    local humanoid = character:FindFirstChild("Humanoid")
    if humanoid then
        humanoid.WalkSpeed = 0
        humanoid.JumpPower = 0
    end

    -- æ–¹æ³•3ï¼šæ¯ç§’æ£€æŸ¥å¹¶ä¿®æ­£ä½ç½®
    selfRescueConnection = RunService.Heartbeat:Connect(function()
        if not isSelfRescueActive or not character or character.Parent == nil then
            stopSelfRescue()
            return
        end
        
        local currentRootPart = character:FindFirstChild("HumanoidRootPart")
        if not currentRootPart then return end
        
        -- å¼ºåˆ¶è®¾ç½®ä½ç½®
        currentRootPart.CFrame = savedCFrame
        
        -- æ›´æ–°BodyPositionä½ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
        local existingBodyPosition = currentRootPart:FindFirstChild("ExpertSelfRescuePosition")
        if existingBodyPosition then
            existingBodyPosition.Position = savedPosition
        else
            -- é‡æ–°æ·»åŠ BodyPosition
            local newBodyPosition = Instance.new("BodyPosition")
            newBodyPosition.Name = "ExpertSelfRescuePosition"
            newBodyPosition.P = 100000
            newBodyPosition.D = 1000
            newBodyPosition.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
            newBodyPosition.Position = savedPosition
            newBodyPosition.Parent = currentRootPart
        end
    end)
    
    -- å¦‚æœå¤„äºç¼©å°æ¨¡å¼ï¼Œæ›´æ–°çŠ¶æ€
    if isMinimized then
        statusLabel.Text = "ğŸ”’ å·²å›ºå®šä½ç½®"
    end
    
    return true
end

local function stopSelfRescue()
    if not isSelfRescueActive then return end
    
    isSelfRescueActive = false
    
    -- æ–­å¼€è¿æ¥
    if selfRescueConnection then
        selfRescueConnection:Disconnect()
        selfRescueConnection = nil
    end
    
    local character = player.Character
    if character then
        local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
        if humanoidRootPart then
            -- ç§»é™¤BodyPosition
            local bodyPosition = humanoidRootPart:FindFirstChild("ExpertSelfRescuePosition")
            if bodyPosition then
                bodyPosition:Destroy()
            end
        end
        
        -- æ¢å¤Humanoidç§»åŠ¨
        local humanoid = character:FindFirstChild("Humanoid")
        if humanoid then
            humanoid.WalkSpeed = 16  -- é»˜è®¤å€¼
            humanoid.JumpPower = 50  -- é»˜è®¤å€¼
        end
    end
    
    selfRescueButton.Text = "è‡ªæ•‘\nå›ºå®šä½ç½® [OFF]"
    selfRescueButton.BackgroundColor3 = Color3.fromRGB(180, 60, 180)  -- æ¢å¤äº®ç´«è‰²
    
    -- å¦‚æœå¤„äºç¼©å°æ¨¡å¼ï¼Œæ¢å¤çŠ¶æ€æ–‡æœ¬
    if isMinimized then
        statusLabel.Text = "Expert\nç‚¹å‡»å±•å¼€"
    end
    
    print("[Expert] å·²åœæ­¢è‡ªæ•‘åŠŸèƒ½ - ä½ç½®è§£é™¤å›ºå®š")
    savedPosition = nil
    savedCFrame = nil
end

-- é€šç”¨ä¼ é€å‡½æ•°
local function performTeleport(location, button, locationName)
    -- å¦‚æœæ­£åœ¨è‡ªæ•‘ï¼Œå…ˆåœæ­¢
    if isSelfRescueActive then
        stopSelfRescue()
    end
    
    local character = player.Character
    if not character then 
        print("[Expert] é”™è¯¯: è§’è‰²ä¸å­˜åœ¨")
        return false
    end

    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then 
        print("[Expert] é”™è¯¯: æ‰¾ä¸åˆ°HumanoidRootPart")
        return false
    end

    -- ä¼ é€åˆ°æŒ‡å®šä½ç½®
    local teleportPos = Vector3.new(
        location.X,
        location.Y,
        location.Z
    )

    humanoidRootPart.CFrame = CFrame.new(teleportPos)

    -- æ›´æ–°æŒ‰é’®æ–‡æœ¬
    if not isMinimized and button then
        local originalText = button.Text
        button.Text = "âœ… å·²ä¼ é€"
        
        -- 3ç§’åæ¢å¤åŸæ–‡æœ¬
        task.wait(3)
        button.Text = originalText
    end

    -- å¦‚æœå¤„äºç¼©å°æ¨¡å¼ï¼Œæ›´æ–°çŠ¶æ€
    if isMinimized then
        statusLabel.Text = "âœ… å·²ä¼ é€" .. locationName
        task.wait(3)
        statusLabel.Text = "Expert\nç‚¹å‡»å±•å¼€"
    end

    print(string.format("[Expert] å·²ä¼ é€åˆ°%s (X:%.1f, Y:%.1f, Z:%.1f)", 
        locationName, location.X, location.Y, location.Z))

    return true
end

-- æ‰§è¡Œç­‰å€™å…ä¼ é€
local function performBackroomTeleport()
    return performTeleport(backroomLocation, backroomTeleportButton, "ç­‰å€™å…")
end

-- æ‰§è¡Œå‰§é™¢ç«è½¦ä¼ é€
local function performTheaterTrainTeleport()
    return performTeleport(theaterTrainLocation, theaterTrainButton, "å‰§é™¢ç«è½¦")
end

-- æ‰§è¡Œå·¥å‚ç«è½¦ä¼ é€
local function performFactoryTrainTeleport()
    return performTeleport(factoryTrainLocation, factoryTrainButton, "å·¥å‚ç«è½¦")
end

-- === æ–°å¢ï¼šè‡ªæ•‘æŒ‰é’®åŠŸèƒ½ ===
selfRescueButton.MouseButton1Click:Connect(function()
    if isSelfRescueActive then
        stopSelfRescue()
    else
        startSelfRescue()
    end
end)

-- ç¼©æ”¾åŠŸèƒ½
zoomBtn.MouseButton1Click:Connect(function()
    isZoomed = not isZoomed

    if isZoomed then
        -- æ”¾å¤§ç•Œé¢ï¼Œä¿æŒå½“å‰ä½ç½®ä¸å˜
        local currentPos = mainFrame.Position
        local tween = TweenService:Create(mainFrame, TweenInfo.new(0.3), {
            Size = zoomedSize,
            Position = currentPos
        })
        tween:Play()

        zoomBtn.Text = "âºï¸"
        zoomBtn.BackgroundColor3 = Color3.fromRGB(80, 140, 220)

        -- æ”¾å¤§åæ›´æ–°æ–‡æœ¬å¤§å°
        if not isMinimized then
            backroomTeleportButton.TextSize = 15
            theaterTrainButton.TextSize = 15
            factoryTrainButton.TextSize = 15
            selfRescueButton.TextSize = 15
            title.TextSize = 15
        end
    else
        -- ç¼©å°åˆ°åŸå§‹å¤§å°ï¼Œä¿æŒå½“å‰ä½ç½®ä¸å˜
        local currentPos = mainFrame.Position
        local tween = TweenService:Create(mainFrame, TweenInfo.new(0.3), {
            Size = originalSize,
            Position = currentPos
        })
        tween:Play()

        zoomBtn.Text = "â¬…ï¸"
        zoomBtn.BackgroundColor3 = Color3.fromRGB(60, 100, 180)

        -- æ¢å¤åŸå§‹æ–‡æœ¬å¤§å°
        if not isMinimized then
            backroomTeleportButton.TextSize = 14
            theaterTrainButton.TextSize = 14
            factoryTrainButton.TextSize = 14
            selfRescueButton.TextSize = 14
            title.TextSize = 14
        end
    end
end)

-- ç¼©å°åŠŸèƒ½
minimizeBtn.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized

    if isMinimized then
        -- ç¼©å°åŠ¨ç”»ï¼Œä¿æŒå½“å‰ä½ç½®
        local currentPos = mainFrame.Position
        local tween = TweenService:Create(mainFrame, TweenInfo.new(0.3), {
            Size = minimizedSize,
            Position = currentPos
        })
        tween:Play()

        tween.Completed:Wait()  -- ç­‰å¾…åŠ¨ç”»å®Œæˆ

        backroomTeleportButton.Visible = false
        theaterTrainButton.Visible = false
        factoryTrainButton.Visible = false
        selfRescueButton.Visible = false  -- æ–°å¢
        statusLabel.Visible = true
        minimizeBtn.Text = "+"
        title.Text = "ğŸ¯"
        
        -- æ ¹æ®å½“å‰çŠ¶æ€æ›´æ–°æ–‡æœ¬
        if isSelfRescueActive then
            statusLabel.Text = "ğŸ”’ å›ºå®šä½ç½®"
        else
            statusLabel.Text = "Expert\nç‚¹å‡»å±•å¼€"
        end

    else
        -- æ¢å¤æ˜¾ç¤º
        backroomTeleportButton.Visible = true
        theaterTrainButton.Visible = true
        factoryTrainButton.Visible = true
        selfRescueButton.Visible = true  -- æ–°å¢
        statusLabel.Visible = false
        minimizeBtn.Text = "_"
        title.Text = "Expert"

        -- æ¢å¤å¤§å°ï¼ˆæ ¹æ®å½“å‰ç¼©æ”¾çŠ¶æ€ï¼‰ï¼Œä¿æŒå½“å‰ä½ç½®
        local currentPos = mainFrame.Position
        local targetSize = isZoomed and zoomedSize or originalSize

        local tween = TweenService:Create(mainFrame, TweenInfo.new(0.3), {
            Size = targetSize,
            Position = currentPos
        })
        tween:Play()
    end
end)

-- å…³é—­åŠŸèƒ½
closeBtn.MouseButton1Click:Connect(function()
    -- åœæ­¢è‡ªæ•‘åŠŸèƒ½
    stopSelfRescue()
    
    -- æ·¡å‡ºåŠ¨ç”»
    local tween = TweenService:Create(mainFrame, TweenInfo.new(0.3), {
        BackgroundTransparency = 0.8,
        Position = mainFrame.Position + UDim2.new(0, 0, 0, -20)
    })
    tween:Play()

    tween.Completed:Wait()  -- ç­‰å¾…åŠ¨ç”»å®Œæˆ
    screenGui:Destroy()
    isRunning = false
end)

-- æŒ‰é’®ç‚¹å‡»äº‹ä»¶
backroomTeleportButton.MouseButton1Click:Connect(function()
    performBackroomTeleport()
end)

theaterTrainButton.MouseButton1Click:Connect(function()
    performTheaterTrainTeleport()
end)

factoryTrainButton.MouseButton1Click:Connect(function()
    performFactoryTrainTeleport()
end)

-- å¿«æ·é”®
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end

    -- Bé”®ï¼šè§¦å‘ç­‰å€™å…ä¼ é€
    if input.KeyCode == Enum.KeyCode.B then
        performBackroomTeleport()
    end

    -- Té”®ï¼šè§¦å‘å‰§é™¢ç«è½¦ä¼ é€
    if input.KeyCode == Enum.KeyCode.T then
        performTheaterTrainTeleport()
    end

    -- Fé”®ï¼šè§¦å‘å·¥å‚ç«è½¦ä¼ é€
    if input.KeyCode == Enum.KeyCode.F then
        performFactoryTrainTeleport()
    end

    -- Ré”®ï¼šè§¦å‘è‡ªæ•‘åŠŸèƒ½ï¼ˆæ–°å¢ï¼‰
    if input.KeyCode == Enum.KeyCode.R then
        if isSelfRescueActive then
            stopSelfRescue()
        else
            startSelfRescue()
        end
    end

    -- Mé”®ï¼šç¼©å°/æ”¾å¤§
    if input.KeyCode == Enum.KeyCode.M then
        isMinimized = not isMinimized

        if isMinimized then
            local currentPos = mainFrame.Position
            local tween = TweenService:Create(mainFrame, TweenInfo.new(0.3), {
                Size = minimizedSize,
                Position = currentPos
            })
            tween:Play()

            tween.Completed:Wait()

            backroomTeleportButton.Visible = false
            theaterTrainButton.Visible = false
            factoryTrainButton.Visible = false
            selfRescueButton.Visible = false
            statusLabel.Visible = true
            minimizeBtn.Text = "+"
            title.Text = "ğŸ¯"
            
            -- æ ¹æ®å½“å‰çŠ¶æ€æ›´æ–°æ–‡æœ¬
            if isSelfRescueActive then
                statusLabel.Text = "ğŸ”’ å›ºå®šä½ç½®"
            else
                statusLabel.Text = "Expert\nç‚¹å‡»å±•å¼€"
            end

        else
            backroomTeleportButton.Visible = true
            theaterTrainButton.Visible = true
            factoryTrainButton.Visible = true
            selfRescueButton.Visible = true
            statusLabel.Visible = false
            minimizeBtn.Text = "_"
            title.Text = "Expert"

            -- æ¢å¤å¤§å°ï¼ˆæ ¹æ®å½“å‰ç¼©æ”¾çŠ¶æ€ï¼‰ï¼Œä¿æŒå½“å‰ä½ç½®
            local currentPos = mainFrame.Position
            local targetSize = isZoomed and zoomedSize or originalSize

            local tween = TweenService:Create(mainFrame, TweenInfo.new(0.3), {
                Size = targetSize,
                Position = currentPos
            })
            tween:Play()
        end
    end

    -- Zé”®ï¼šè§¦å‘ç¼©æ”¾
    if input.KeyCode == Enum.KeyCode.Z then
        isZoomed = not isZoomed

        if isZoomed then
            -- æ”¾å¤§ç•Œé¢ï¼Œä¿æŒå½“å‰ä½ç½®
            local currentPos = mainFrame.Position
            local tween = TweenService:Create(mainFrame, TweenInfo.new(0.3), {
                Size = zoomedSize,
                Position = currentPos
            })
            tween:Play()

            zoomBtn.Text = "â–¶ï¸"
            zoomBtn.BackgroundColor3 = Color3.fromRGB(80, 140, 220)

            -- æ”¾å¤§åæ›´æ–°æ–‡æœ¬å¤§å°
            if not isMinimized then
                backroomTeleportButton.TextSize = 15
                theaterTrainButton.TextSize = 15
                factoryTrainButton.TextSize = 15
                selfRescueButton.TextSize = 15
                title.TextSize = 15
            end
        else
            -- ç¼©å°åˆ°åŸå§‹å¤§å°ï¼Œä¿æŒå½“å‰ä½ç½®
            local currentPos = mainFrame.Position
            local tween = TweenService:Create(mainFrame, TweenInfo.new(0.3), {
                Size = originalSize,
                Position = currentPos
            })
            tween:Play()

            zoomBtn.Text = "â¸ï¸"
            zoomBtn.BackgroundColor3 = Color3.fromRGB(60, 100, 180)

            -- æ¢å¤åŸå§‹æ–‡æœ¬å¤§å°
            if not isMinimized then
                backroomTeleportButton.TextSize = 14
                theaterTrainButton.TextSize = 14
                factoryTrainButton.TextSize = 14
                selfRescueButton.TextSize = 14
                title.TextSize = 14
            end
        end
    end
end)

-- åˆå§‹æ·¡å…¥åŠ¨ç”»
local originalPosition = UDim2.new(0.02, 0, 0.3, 0)  -- æ˜ç¡®å®šä¹‰åŸå§‹ä½ç½®
mainFrame.BackgroundTransparency = 1
mainFrame.Position = originalPosition + UDim2.new(0, 0, 0, -30)

task.wait(0.1)

local fadeInTween = TweenService:Create(mainFrame, TweenInfo.new(0.5), {
    BackgroundTransparency = 0.2,
    Position = originalPosition
})
fadeInTween:Play()

-- è§’è‰²æ­»äº¡æˆ–é‡ç”Ÿæ—¶è‡ªåŠ¨åœæ­¢è‡ªæ•‘åŠŸèƒ½
player.CharacterAdded:Connect(function(character)
    if isSelfRescueActive then
        print("[Expert] è§’è‰²é‡ç”Ÿï¼Œåœæ­¢è‡ªæ•‘åŠŸèƒ½")
        stopSelfRescue()
    end
end)

print("=== Expertè„šæœ¬å·²åŠ è½½ ===")
print(string.format("ç­‰å€™å…åæ ‡: X:%.2f, Y:%.2f, Z:%.2f", 
    backroomLocation.X, backroomLocation.Y, backroomLocation.Z))
print(string.format("å‰§é™¢ç«è½¦åæ ‡: X:%.1f, Y:%.1f, Z:%.1f", 
    theaterTrainLocation.X, theaterTrainLocation.Y, theaterTrainLocation.Z))
print(string.format("å·¥å‚ç«è½¦åæ ‡: X:%.0f, Y:%.0f, Z:%.0f", 
    factoryTrainLocation.X, factoryTrainLocation.Y, factoryTrainLocation.Z))
print("å¿«æ·é”®æŒ‡å—:")
print("  Bé”® - ä¼ é€åˆ°ç­‰å€™å…")
print("  Té”® - ä¼ é€åˆ°å‰§é™¢ç«è½¦")
print("  Fé”® - ä¼ é€åˆ°å·¥å‚ç«è½¦")
print("  Ré”® - è‡ªæ•‘/å›ºå®šä½ç½® (æ–°å¢)")
print("  Mé”® - ç¼©å°/æ”¾å¤§ç•Œé¢")
print("  Zé”® - ç¼©æ”¾ç•Œé¢")
print("è‡ªæ•‘åŠŸèƒ½è¯´æ˜:")
print("  1. ç‚¹å‡»æŒ‰é’®æˆ–æŒ‰Ré”®å›ºå®šå½“å‰ä½ç½®")
print("  2. è§’è‰²å°†è¢«é”å®šï¼Œæ— æ³•ç§»åŠ¨")
print("  3. å†æ¬¡ç‚¹å‡»æˆ–æŒ‰Ré”®è§£é™¤å›ºå®š")
print("  4. è§’è‰²æ­»äº¡æˆ–é‡ç”Ÿæ—¶è‡ªåŠ¨è§£é™¤")
print("çŠ¶æ€: å°±ç»ª")

game:GetService("StarterGui"):SetCore("SendNotification", {
    Title = "Expert",
    Text = "è‡ªæ•‘åŠŸèƒ½å·²æ·»åŠ  - æŒ‰Ré”®å›ºå®šä½ç½®",
    Icon = "rbxassetid://14550088217",
    Duration = 5,
    Position = UDim2.new(0, 20, 1, -50)
})